function varargout = CycleMaster(varargin)
% CYCLEMASTER MATLAB code for CycleMaster.fig
%      CYCLEMASTER, by itself, creates a new CYCLEMASTER or raises the existing
%      singleton*.
%
%      H = CYCLEMASTER returns the handle to a new CYCLEMASTER or the handle to
%      the existing singleton*.
%
%      CYCLEMASTER('CALLBACK',hObject,eventData,handles,...) calls the local
%      function named CALLBACK in CYCLEMASTER.M with the given input arguments.
%
%      CYCLEMASTER('Property','Value',...) creates a new CYCLEMASTER or raises the
%      existing singleton*.  Starting from the left, property value pairs are
%      applied to the GUI before CycleMaster_OpeningFcn gets called.  An
%      unrecognized property name or invalid value makes property application
%      stop.  All inputs are passed to CycleMaster_OpeningFcn via varargin.
%
%      *See GUI Options on GUIDE's Tools menu.  Choose "GUI allows only one
%      instance to run (singleton)".
%
% See also: GUIDE, GUIDATA, GUIHANDLES

% Author:   Eric Simon
% History:  09.16.2014  Edited original file created by Jared
%           1. Added variable names when loading the NormalizedData.mat
%           file and issue an error when it is improperly loaded.

%           2. Disabled the set Plot Sum of Squares button until after the
%           power curve data was loaded.

%           3. Changed the database reference to ETRE instead of VTRE and
%           made minor changes to the SQL statements being used in order to
%           restore communication with the database.

%           4. Eliminated calculations for LoMaxTorqueSpeed and
%           HiMaxTorqueSpeed used to calculate Intermediate Speed, which is
%           now calculated by calling the calculateIntermediateSpeed
%           function in accordance with 1065.610(c)(3).
%
%           5. Moved the calculation for max test speed, speed at Pmax, and
%           the SS of normalized power and speed to the findMaxTestSpeed
%           function in accordance with 1065.610(a). Renamed the handles
%           variables handles.Part1065SpeedPmax to handles.SpeedAtPmax and
%           references to Average 98% Power Speed to Max Test Speed.

%           6. Corrected the manner in which the power curve duration was
%           being calculated; note, though, that it still relies on data
%           being collected at a constant frequency.

%           7. Although there is some functionality available to load in
%           friction curves it doesn't work well and can cause errors.
%           Therefore I disables the controls related to friction curves
%           with the idea that it will be revisited in a future revision.

%           8. Made minor changes to the GUI.

% Begin GUI initialization code auto-generated by GUIDE - DO NOT EDIT
gui_Singleton = 1;
gui_State = struct('gui_Name',       mfilename, ...
                   'gui_Singleton',  gui_Singleton, ...
                   'gui_OpeningFcn', @CycleMaster_OpeningFcn, ...
                   'gui_OutputFcn',  @CycleMaster_OutputFcn, ...
                   'gui_LayoutFcn',  [] , ...
                   'gui_Callback',   []);
if nargin && ischar(varargin{1})
    gui_State.gui_Callback = str2func(varargin{1});
end

if nargout
    [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
else
    gui_mainfcn(gui_State, varargin{:});
end
% End GUI initialization code auto-generated by GUIDE - DO NOT EDIT

% --- Executes just before CycleMaster is made visible.
function CycleMaster_OpeningFcn(hObject, eventdata, handles, varargin)
% This function has no output args, see OutputFcn.
% hObject    handle to figure
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% varargin   command line arguments to CycleMaster (see VARARGIN)

% Verify that the proper files are being used
% verifyToolFilePath('CycleMaster_Copy.m','CycleMaster_dependencies.mat',1);

% Move to MATLAB start folder
cd C:\MATLAB

% Clear out current path
restoredefaultpath

% Add appropriate subdirectories
addpath(genpath(pwd))

% This sets the default directory. The user can change this directory from the GUI.
if exist('D:\Testing\Engine\','dir')
    cd('D:\Testing\Engine\');
end

% Load the NormalizedData.mat file located in the tool directory.
createError = warning('error','MATLAB:load:variableNotFound');
try
    % Note: The handles.Cycle cell array contains the available cycles and
    % is defined in the CycleSelecter_CreateFcn and only used here and in
    % various places throughout the code. Also note that we could use this
    % array to create dynamic variable names using genvarname. This would
    % allow this list to be defined in one place and improve our ability to
    % more easily add new cycles. The downside to that approach is code
    % readability. So for the timg being, this basic list will be created
    % numerous times.
    load('NormalizedData.mat', handles.Cycle{:});
catch ME
    % Throw a command window error and terminate m-file execution. We don't
    % want to allow the user to continue if the NormalizedData.mat
    % variables haven't been properly loaded.
    error(ME.message);
end

% Initialize handles variables from the matfile. Note: These are the same
% variables in the handles.Cycle cell array referred to above.
handles.NormETC = ETC;
handles.NormFTP_Diesel = FTP_Diesel;
handles.NormFTP_Otto = FTP_Otto;
handles.NormLSINRTC = LSINRTC;
handles.NormNRTC = NRTC;
handles.NormRMC = RMC;
handles.NormRMCNR = RMCNR;
handles.Norm13M = ThirteenM;
handles.NormWHSC = WHSC;
handles.NormWHTC = WHTC;

handles.Methodology = 'Part 86';
handles.PowerCurveSpeed = 0;
handles.PowerCurveTorque = 0;
handles.PowerCurveThrottle = 0;
handles.MetricUnits = 1;

% Inititialize Object Properties
set(handles.UseFrictionCurve,'Value',0);
set(handles.FrictionCurvePath,'String','Using negative 40% of power curve');
set(handles.getFrictionCurve,'Enable','off');

set(handles.PlotSumSquares,'Enable','off'); % Can't plot until a power curve has been loaded

set(handles.PowerCurveAxes,'YAxisLocation','right' ...
                          ,'XAxisLocation','top' ...
                          ,'XTickLabel','' ...
                          ,'Box','off' ...
                          ,'YColor','r' ...
                          ,'FontSize',8);
ylabel(handles.PowerCurveAxes,'Power (kW)');

set(handles.TorqueCurveAxes,'Color','none' ...
                           ,'YColor','b' ...
                           ,'Box','off' ...
                           ,'FontSize',8);
xlabel(handles.TorqueCurveAxes,'Engine Speed (RPM)');
ylabel(handles.TorqueCurveAxes,'Torque (N.m)');

set(handles.LoadCycleAxes,'YAxisLocation','right' ...
                          ,'XAxisLocation','top' ...
                          ,'XTickLabel','' ...
                          ,'Box','off' ...
                          ,'YColor','r' ...
                          ,'FontSize',8);
ylabel(handles.LoadCycleAxes,'Torque (N.m)');

set(handles.SpeedCycleAxes,'Color','none' ...
                           ,'YColor','b' ...
                           ,'Box','off' ...
                           ,'FontSize',8);
xlabel(handles.SpeedCycleAxes,'Time (s)');
ylabel(handles.SpeedCycleAxes,'Engine Speed (RPM)');

set(handles.SampleBasis,'Visible','off');
set(handles.optSampleBasis,'Visible','off');

% Choose default command line output for CycleMaster
handles.output = hObject;

% Update handles structure
guidata(hObject, handles);

% Set the default Cycle Development to FTP-Diesel 
HideAllOptions(handles);
ShowStandardTransientOptions(handles);
set(handles.CycleSelecter,'Value',2); % Set to FTP-Diesel
set(handles.uipanel8,'Title','FTP-Diesel Options');

% --- Outputs from this function are returned to the command line.
function varargout = CycleMaster_OutputFcn(hObject, eventdata, handles)
% varargout  cell array for returning output args (see VARARGOUT);
% hObject    handle to figure
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Get default command line output from handles structure
varargout{1} = handles.output;

% --- Executes on button press in getPowerCurve.
function getPowerCurve_Callback(hObject, eventdata, handles)
% hObject    handle to getPowerCurve (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

[filename, pathname] = uigetfile('*.csv');

% If no file was chosen, jump out of the callback function
if filename == 0, return; end

% Set the text input to indicate the filename
set(handles.PowerCurvePath,'String',filename);

% Set the handles.PowerCurveName to not include the extension
[~, handles.PowerCurveName, ~] = fileparts(filename);

% Create the handles.PowerCurveFile to inlcude the path, filename, and
% extension
handles.PowerCurveFile = fullfile(pathname, filename);

% Put the filepath in the MATLAB path variable
cd(pathname);

% Load the selected power curve and manipulate the data per the Electronic
% Code of Federal Regulations, Title 40 -> Chapter I -> Subchapter U ->
% Part 1065.

set(handles.lblBusy,'Visible','on');
pause(0.1);
set(handles.CreatePlayback,'Enable','off');

% Store changes
guidata(hObject, handles);

% This is a little odd as handles.MetricUnits is initialized to 1 and
% apparently never changed. I'll keep things as they are for now.
if handles.MetricUnits
    tPowerCurveSpeed = 0;
    tPowerCurveTorque = 0;
    tPowerCurveThrottle = 0;
    tAllData = mImport(handles.PowerCurveFile, 1);
    for k = 1:size(tAllData,2)
        % This will not complain if all the channels are correctly labeled
        switch tAllData{1,k}
            case 'Time'
                tData = tAllData(2:end,k);
                tTime = [tData{:}]';
                tTimeDeltas = diff(tTime);
            case 'Mode'
                tData = tAllData(2:end,k);
                tMode = [tData{:}]';
            case 'P_SimBaro (mm.Hg)'
                tData = tAllData(2:end,k);
                tPSimBaro = [tData{:}]';
            case 'T_In_Air (C°)'
                tData = tAllData(2:end,k);
                tTInAir = [tData{:}]';
            case 'DT_Air_2 (C°)'
                tData = tAllData(2:end,k);
                tDTAir2 = [tData{:}]';
            case 'Eng_Speed (RPM)'
                tData = tAllData(2:end,k);
                tPowerCurveSpeed = [tData{:}]';
            case 'Torque (N.m)'
                tData = tAllData(2:end,k);
                tPowerCurveTorque = [tData{:}]';
            case 'SP_Throttle (%)'
                tData = tAllData(2:end,k);
                tPowerCurveThrottle = [tData{:}]';
            otherwise
        end
    end

    % We expect the data to be 1 Hertz. We will, however, use the most
    % "common" delta and report any differences.
    DELTAT = mode(tTimeDeltas);
    IntervalChk = find(tTimeDeltas ~= DELTAT);
    if ~isempty(IntervalChk), warning('MATLAB:CycleMaster','Not every time delta was %i second(s)!', DELTAT); end

    % Grab the test number by breaking the file name into consituent
    % pieces. Note that this requires the files to be named such that the
    % fourth element is the test number and the underscore (_) is the
    % delimiter.
    TestNumber = stringread(handles.PowerCurveName, '_');
    TestNumber = TestNumber{4};

    % Grab test-related data from the ETRE database.
    try
        NET.addAssembly('System.Data'); %this imports the library into MATLAB
        connString = 'DSN=ETRE';
        odbcCN = System.Data.Odbc.OdbcConnection(connString);
        odbcCN.Open(); % connects to the SQL Server (must have DSN) - if no DSN give some barebones values

        % Grab a single row; assumes Test_Number is unique
        sql = ['SELECT * FROM tblTestResults WHERE Test_Number = ' num2str(TestNumber)];
        odbcCOM = System.Data.Odbc.OdbcCommand(sql, odbcCN);
        res = odbcCOM.ExecuteReader();
        res.Read();

        handles.Customer = char(res.GetValue(6));
        handles.Engine = char(res.GetValue(7));
        handles.Cell = char(res.GetValue(3));
        dvec(1) = double(res.GetValue(4).Year);
        dvec(2) = double(res.GetValue(4).Month);
        dvec(3) = double(res.GetValue(4).Day);
        dvec(4) = double(res.GetValue(4).Hour);
        dvec(5) = double(res.GetValue(4).Minute);
        dvec(6) = double(res.GetValue(4).Second);
        handles.Date = datestr(dvec, 2);
        handles.Time = datestr(dvec, 'HH:MM AM');
        res.Close();

        sql = ['SELECT * FROM engine WHERE Control = ''' handles.Engine ''''];
        odbcCOM = System.Data.Odbc.OdbcCommand(sql, odbcCN);
        res = odbcCOM.ExecuteReader();

        res.Read();

        handles.Project = char(res.GetValue(40));
        handles.DeclaredMaxPower = num2str(double(res.GetValue(32)));
        handles.DeclaredMaxTorque = num2str(double(res.GetValue(33)));
        handles.DeclaredMaxPowerSpeed = num2str(double(res.GetValue(26)));
        handles.DeclaredMaxTorqueSpeed = num2str(double(res.GetValue(27)));
        res.Close();

        if strcmp(handles.DeclaredMaxPower, '0'), handles.DeclaredMaxPower = '-'; end;
        if strcmp(handles.DeclaredMaxTorque, '0'), handles.DeclaredMaxTorque = '-'; end;
        if strcmp(handles.DeclaredMaxPowerSpeed, '0'), handles.DeclaredMaxPowerSpeed = '-'; end;
        if strcmp(handles.DeclaredMaxTorqueSpeed, '0'), handles.DeclaredMaxTorqueSpeed = '-'; end;
    catch %#ok
        try
            res.Close();
        catch %#ok
        end

        handles.Customer = '';
        handles.Project = '';
        handles.Engine = '';
        handles.Cell = '';
        handles.Date = '';
        handles.Time = '';

        handles.DeclaredMaxPower = '-';
        handles.DeclaredMaxTorque = '-';
        handles.DeclaredMaxPowerSpeed = '-';
        handles.DeclaredMaxTorqueSpeed = '-';
    end

    % Grab data (Mode == 6)
    handles.PowerCurveSpeed = tPowerCurveSpeed(tMode == 6);
    if any(tPowerCurveTorque), handles.PowerCurveTorque = tPowerCurveTorque(tMode == 6); else warning('MATLAB:CycleMaster','Torque was not captured'); end;
    if any(tPowerCurveThrottle), handles.PowerCurveThrottle = tPowerCurveThrottle(tMode == 6); else warning('MATLAB:CycleMaster','Throttle was not captured'); end;

    % Calculate power(kW) from speed(rpm) and torque(Nm)
    handles.PowerCurvePower = handles.PowerCurveSpeed.*handles.PowerCurveTorque*pi/30000;

    handles.PSimBaro = mean(tPSimBaro(tMode==6));
    handles.TInAir = mean(tTInAir(tMode==6));
    handles.DTAir2 = mean(tDTAir2(tMode==6));

    plot(handles.TorqueCurveAxes, handles.PowerCurveSpeed, handles.PowerCurveTorque);
    plot(handles.PowerCurveAxes,handles.PowerCurveSpeed, handles.PowerCurvePower,'r');

    % Add reference lines (INCLUDED FOR FUTURE REFERENCE; NOT USED)
    % line(xlim(handles.PowerCurveAxes),[300 300],'Parent',handles.PowerCurveAxes,'Color','g','LineStyle','--');

    set(handles.PowerCurveAxes,'YAxisLocation','right' ...
                              ,'XAxisLocation','top' ...
                              ,'XTickLabel','' ...
                              ,'Box','off' ...
                              ,'YColor','r');
    set(handles.TorqueCurveAxes,'Color','none' ...
                               ,'YColor','b' ...
                               ,'Box','off');
    xlabel(handles.TorqueCurveAxes,'Engine Speed (RPM)');
    ylabel(handles.TorqueCurveAxes,'Torque (N.m)');
    ylabel(handles.PowerCurveAxes,'Power (kW)');
    guidata(hObject, handles);

    handles.MeasMaximumPower = max(handles.PowerCurvePower);
    handles.MaxPowerSpeed = min(handles.PowerCurveSpeed(handles.PowerCurvePower == handles.MeasMaximumPower));

    handles.MeasMaximumTorque = max(handles.PowerCurveTorque);
    handles.MaxTorqueSpeed = min(handles.PowerCurveSpeed(handles.PowerCurveTorque == handles.MeasMaximumTorque));

    handles.MaxMappedSpeed = max(handles.PowerCurveSpeed);
    handles.MinMappedSpeed = min(handles.PowerCurveSpeed);

    handles.MeasIdleSpeed = mean(tPowerCurveSpeed(tMode == 2));
    handles.MeasIdleTorque = mean(tPowerCurveTorque(tMode == 2));
    handles.MeasIdleTorqueDev = max(abs(tPowerCurveTorque(tMode == 2))-handles.MeasIdleTorque);

    handles.MeasCITTSpeed = mean(tPowerCurveSpeed(tMode == 4));
    handles.MeasCITTTorque = mean(tPowerCurveTorque(tMode == 4));
    handles.MeasCITTTorqueDev = max(abs(tPowerCurveTorque(tMode == 4))-handles.MeasCITTTorque);

    set(handles.lblIdleSpeed,'String',sprintf('%0.1f RPM ',handles.MeasIdleSpeed));
    set(handles.lblCITTSpeed,'String',sprintf('%0.1f RPM ',handles.MeasCITTSpeed));

    handles.Nhi = 0;
    handles.Nlo = 0;
    
    % ---------------------------------------------------------------------
    % Calculate Stage V requirements quantities
    %   We'll calculate these for all power curves. Since this is the case
    %   we'll make sure to trap any errors.
    % ---------------------------------------------------------------------
    
    % Initialize WH quantities (not sure what values to set them to so I'll
    % just set them all to zero except Nidle).
    handles.WH_Nidle = handles.MeasIdleSpeed; % This is the minimum mapping speed per 7.4.2
    handles.WH_Nlo = 0;
    handles.WH_Nhi = 0;
    handles.WH_N95h = 0;
    handles.WH_Npref = 0;
    
    % Calculate Nlo as the lowest speed at which 55% of maximum power
    % (Pmax) occurs, N95h as the highest speed corresponding to 95% of
    % Pmax, and Nhi as the highest speed corresponding to 70% of Pmax.
    % Refer to R049r6e_Annex4, 7.4.6.
    try 
        handles.WH_Nlo = min(speedAtPctPower(handles.PowerCurvePower, handles.PowerCurveSpeed, 55)); 
    catch ME
        warning('There was a problem calculating World Harmonized Nlo! %s: %s', ME.identifier, ME.message);
    end
    
    try
        handles.WH_Nhi = max(speedAtPctPower(handles.PowerCurvePower, handles.PowerCurveSpeed, 70));
    catch ME
        warning('There was a problem calculating World Harmonized Nhi! %s: %s', ME.identifier, ME.message);
    end    
        
    try
        handles.WH_N95h = max(speedAtPctPower(handles.PowerCurvePower, handles.PowerCurveSpeed, 95));
    catch ME
        warning('There was a problem calculating World Harmonized N95h! %s: %s', ME.identifier, ME.message);
    end           
    
    % Calculate Npref as the engine speed where the integral of maximum
    % mapped torque from n_idle to n_pref is 51 percent of the whole
    % integral between n_idle and n_95h.
    try
        handles.WH_Npref = area51(handles.PowerCurveSpeed, handles.PowerCurveTorque, handles.WH_Nidle, handles.WH_N95h);
    catch ME
        warning('There was a problem calculating World Harmonized Npref! %s: %s', ME.identifier, ME.message);
    end   

    % ---------------------------------------------------------------------
    % Calculate Nhi and Nlo (old code)  
    % ---------------------------------------------------------------------
%     for k = 1:length(handles.PowerCurvePower)
% 
%         % Calculate Nhi as the last point such that power is at least 70%
%         % maximum power.
%         if (handles.PowerCurvePower(k) >= 0.7*handles.MeasMaximumPower)
%             handles.Nhi = handles.PowerCurveSpeed(k);
%         end
% 
%         % Calculate Nlo as the first point such that power is at least 50%
%         % maximum power.
%         if (handles.Nlo == 0) && (handles.PowerCurvePower(k) >= 0.5*handles.MeasMaximumPower)
%             handles.Nlo = handles.PowerCurveSpeed(k);
%         end
%         
%     end
    
    % ---------------------------------------------------------------------
    % Calculate Nhi and Nlo (new code)  
    % ---------------------------------------------------------------------    
    handles.Nhi = max(speedAtPctPower(handles.PowerCurvePower, handles.PowerCurveSpeed, 70));
    handles.Nlo = min(speedAtPctPower(handles.PowerCurvePower, handles.PowerCurveSpeed, 50));

    % Find the maximum test speed, the speed at Pmax, and return the sum-of-squares vector
    [~, ~, handles.MaxTestSpeed, ~, ~, handles.SpeedAtPmax, handles.sumSquares] = findMaxTestSpeed(handles.PowerCurveSpeed, handles.PowerCurvePower);

    % Find the maxium test torque. This is described in eCFR 1065.610(b) (this isn't being used)
    % [Ttest, SS] = findMaxTestTorque(handles.PowerCurveTorque, handles.PowerCurveSpeed, handles.PowerCurvePower);
    Ttest = abscissaInterp(handles.PowerCurveSpeed, handles.PowerCurveTorque, handles.MaxTestSpeed);


    % Calculate A, B, and C speeds
    handles.MeasASpeed = handles.Nlo+0.25*(handles.Nhi-handles.Nlo);
    handles.MeasBSpeed = handles.Nlo+0.5*(handles.Nhi-handles.Nlo);
    handles.MeasCSpeed = handles.Nlo+0.75*(handles.Nhi-handles.Nlo);

    % Calculate the Intermediate Speed
    [~, ~, ~, handles.MeasIntermediateSpeed] = calculateIntermediateSpeed(handles.PowerCurveTorque, handles.PowerCurveSpeed, handles.MaxTestSpeed);

    % Assumes a constant delta t and calculate duration
    handles.Duration = length(handles.PowerCurveSpeed)* DELTAT;

    % Calculate the ramp rate as the time required to go from the minimum
    % measured speed during mode 6 to the maximum measured speed during
    % mode 6. Note that for this quantity doesn't really represent a ramp
    % rate since it isn't necessarily monotonic increasing in mode 6.
    % Revisit later.
    handles.RampRate = (max(handles.PowerCurveSpeed)-min(handles.PowerCurveSpeed)) / handles.Duration;

    % Write the calculations to the GUI
    set(handles.MaximumPower,'String',sprintf('%0.1f kW ',handles.MeasMaximumPower));
    set(handles.MaximumPowerSpeed,'String',sprintf('%0.1f RPM ',handles.MaxPowerSpeed));
    set(handles.MaximumTorque,'String',sprintf('%0.1f N.m ',handles.MeasMaximumTorque));
    set(handles.MaximumTorqueSpeed,'String',sprintf('%0.1f RPM ',handles.MaxTorqueSpeed));
    set(handles.MaximumSpeedAtPmax,'String',sprintf('%0.0f RPM ',handles.SpeedAtPmax));
    set(handles.ASpeed,'String',sprintf('%0.0f RPM ',handles.MeasASpeed));
    set(handles.BSpeed,'String',sprintf('%0.0f RPM ',handles.MeasBSpeed));
    set(handles.CSpeed,'String',sprintf('%0.0f RPM ',handles.MeasCSpeed));

    if get(handles.UsePart1065Method,'Value')
        set(handles.RatedSpeed,'String',sprintf('%0.1f',handles.MaxTestSpeed));
    else
        set(handles.RatedSpeed,'String',sprintf('%0.1f',handles.SpeedAtPmax));
    end

    set(handles.IdleSpeed,'String',sprintf('%0.1f',handles.MeasIdleSpeed));
    set(handles.RMCIdleSpeed,'String',sprintf('%0.1f',handles.MeasIdleSpeed));
    set(handles.RMCASpeed,'String',sprintf('%0.1f',handles.MeasASpeed));
    set(handles.RMCBSpeed,'String',sprintf('%0.1f',handles.MeasBSpeed));
    set(handles.RMCCSpeed,'String',sprintf('%0.1f',handles.MeasCSpeed));

    set(handles.MeasMaxTestSpeed,'String',sprintf('%0.0f RPM',handles.MaxTestSpeed));
    set(handles.IntermediateSpeed,'String',[sprintf('%0.0f',handles.MeasIntermediateSpeed) ' RPM']);

    set(handles.CurveDuration,'String',[sprintf('%0.0f',handles.Duration) ' s']);
    set(handles.CurveRampRate,'String',[sprintf('%0.2f',handles.RampRate) ' RPM/s']);
    
    set(handles.WHIdleSpeed,'String',sprintf('%0.1f',handles.WH_Nidle)); 
    set(handles.WHnlo,'String',sprintf('%0.1f',handles.WH_Nlo));
    set(handles.WHnpref,'String',sprintf('%0.1f',handles.WH_Npref));
    set(handles.WHn95h,'String',sprintf('%0.1f',handles.WH_N95h));
    set(handles.WHnhi,'String',sprintf('%0.1f',handles.WH_Nhi));

    % Create the output file default directory
    N = strfind(pathname,'\Data');
    if ~isempty(N) && length(N) == 1
        OutputDir = [pathname(1:N) 'Engineering\Playbacks'];
        if exist(OutputDir,'dir')
            set(handles.OutputDirectory, 'String', OutputDir);
        end
    else
       if exist(pathname,'dir')
          set(handles.OutputDirectory, 'String', pathname);
       end
    end
    verifyOutputDir(handles);

    % Now that the file is loaded, enable GUI controls and turn off Busy
    % message
    set(handles.CreateCycle,'Enable','on')
    set(handles.PlotSumSquares,'Enable','on'); % Now that the data is loaded it is possible to create the plot
    set(handles.OutputDirectory,'Enable','On'); % Enable the output directory text box
    set(handles.lblBusy,'Visible','off');
    pause(0.1);

	guidata(hObject, handles);
end

% --- Executes on button press in getFrictionCurve.
function getFrictionCurve_Callback(hObject, eventdata, handles)
% hObject    handle to getFrictionCurve (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
[filename, pathname] = uigetfile('*.csv','MultiSelect','on');
if filename == 0, return; end
set(handles.FrictionCurvePath,'String',filename);
handles.FrictionCurveFile = fullfile(pathname, filename);
guidata(hObject, handles);

    tFrictionCurveSpeed = 0;
    tFrictionCurveTorque = 0;
    tFrictionCurveThrottle = 0;
    tAllData = mImport(handles.PowerCurveFile, 1);
    for k = 1:size(tAllData,2)
        % This will not complain if all the channels are correctly labeled
        switch tAllData{1,k}
            case 'Eng_Speed (RPM)'
                tData = tAllData(2:end,k);
                tFrictionCurveSpeed = [tData{:}]';
            case 'Torque (N.m)'
                tData = tAllData(2:end,k);
                tFrictionCurveTorque = [tData{:}]';
            case 'SP_Throttle (%)'
                tData = tAllData(2:end,k);
                tFrictionCurveThrottle = [tData{:}]';
            otherwise
        end
    end
    if length(tFrictionCurveSpeed) > 700 %likely 10Hz; 6 rpm/s 2000 rpm -> 333 seconds
        OFFSET = 10; % this limits how much of the top speed is capped off
        ALLOWANCE = 1; % this applies when there is speed lost during the sweep
        % ALLOWANCE allows for however many points where an OFFSET speed gain
        % is less than one. If a large offset (> 2 seconds) is not successful
        % ALLOWANCE is the best way to try and get CycleMaster to accept a
        % sweep
    else
        OFFSET = 2;
        ALLOWANCE = 1;
    end
    A = tFrictionCurveSpeed(1          : end-OFFSET);
    B = tFrictionCurveSpeed(1+OFFSET   : end);
    Delta = find((B-A) > 1);
    if ~(max(Delta) - min(Delta) + 1 == length(Delta))
        % so just take the longest series
        start = Delta(1);
        best = 0;
        for k = 1:length(Delta)-1
            if  Delta(k+1) - Delta(k) > ALLOWANCE
                if Delta(k) - start > best
                    best = Delta(k) - start;
                    minR = start;
                    maxR = Delta(k);
                end
                start = Delta(k+1);
            end
        end
    else
        % other wise an 8 sample increase greater than one is confined to a
        % continuous stretch so take the minimum and maximum
        maxR = max(Delta);
        minR = min(Delta);
    end
    handles.FrictionCurveSpeed = tFrictionCurveSpeed(minR:maxR);
    if tFrictionCurveTorque, handles.FrictionCurveTorque = tFrictionCurveTorque(minR:maxR); end;
    if tFrictionCurveThrottle, handles.FrictionCurveThrottle = tFrictionCurveThrottle(minR:maxR); end;
    handles.FrictionCurveModel = polyfit(handles.FrictionCurveSpeed,handles.FrictionCurveTorque,2);
    guidata(hObject, handles);

% --- Executes on button press in UseFrictionCurve.
function UseFrictionCurve_Callback(hObject, eventdata, handles)
% hObject    handle to UseFrictionCurve (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% Hint: get(hObject,'Value') returns toggle state of UseFrictionCurve
if get(hObject,'Value')
    [~, tFilename, ~] = fileparts(handles.FrictionCurveFile);
    set(handles.FrictionCurvePath,'String',tFilename);
    set(handles.getFrictionCurve,'Enable','on');
else
    set(handles.FrictionCurvePath,'String','Using negative 40% of power curve');
    set(handles.getFrictionCurve,'Enable','off');
end
guidata(hObject,handles);

% --- Executes on selection change in CycleSelecter.
function CycleSelecter_Callback(hObject, eventdata, handles)
% hObject    handle to CycleSelecter (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% Hints: contents = cellstr(get(hObject,'String')) returns CycleSelecter contents as cell array
%        contents{get(hObject,'Value')} returns selected item from CycleSelecter

set(handles.CreatePlayback,'Enable','off');

switch handles.Cycle{get(handles.CycleSelecter,'Value')} % Grab the cycle name

    case 'ETC'
        HideAllOptions(handles);
        ShowStandardTransientOptions(handles);
        set(handles.uipanel8,'Title','ETC Options');

    case 'FTP_Diesel'
        HideAllOptions(handles);
        ShowStandardTransientOptions(handles);
        set(handles.uipanel8,'Title','FTP-Diesel Options');

    case 'FTP_Otto'
        HideAllOptions(handles);
        ShowStandardTransientOptions(handles);
        set(handles.uipanel8,'Title','FTP-Otto Options');

    case 'LSINRTC'
        HideAllOptions(handles);
        ShowStandardTransientOptions(handles);
        set(handles.uipanel8,'Title','LSINRTC Options');
        
    case 'NRTC'
        HideAllOptions(handles);
        ShowStandardTransientOptions(handles);
        set(handles.uipanel8,'Title','NRTC Options');

    case 'RMC'
        HideAllOptions(handles);
        ShowRMCOptions(handles);
        set(handles.uipanel8,'Title','RMC Options');

    case 'RMCNR'
        HideAllOptions(handles);
        ShowRMCNROptions(handles);
        set(handles.uipanel8,'Title','RMCNR Options');

    case 'ThirteenM'
        HideAllOptions(handles);
        ShowRMCOptions(handles);
        set(handles.SampleBasis,'Visible','on');
        set(handles.optSampleBasis,'Visible','on');
        set(handles.uipanel8,'Title','13M Options');
        
    case 'WHSC'
        HideAllOptions(handles);
        ShowWHOptions(handles);
        set(handles.uipanel8,'Title','WHSC Options');
        
    case 'WHTC'
        HideAllOptions(handles);
        ShowWHOptions(handles); 
        set(handles.uipanel8,'Title','WHTC Options');
        
    case 'EightM'
        % Not included on dropdown list so this case shouldn't be possible
        HideAllOptions(handles);
        Show8MOptions(handles);
        set(handles.uipanel8,'Title','8M Options');

end
guidata(hObject,handles);

% --- Executes on button press in UsePart1065Method.
function UsePart1065Method_Callback(hObject, eventdata, handles)
% hObject    handle to UsePart1065Method (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hint: get(hObject,'Value') returns toggle state of UsePart1065Method
set(handles.CreatePlayback,'Enable','off');
if get(hObject,'Value')
    set(hObject, 'String', 'Use Part 1065 Methodology');
    handles.Methodology = 'Part 1065';
    if ~strcmp(get(handles.RatedSpeed,'String'),'-')
        set(handles.RatedSpeed,'String',sprintf('%0.1f',handles.MaxTestSpeed));
    end
else
    % Use Part 86 Methodology
    handles.Methodology = 'Part 86';
    if ~strcmp(get(handles.RatedSpeed,'String'),'-')
        % EDS - According to NB 2/29/2016, this is no longer true for Part
        % 86, so we'll just comment it out for now and replace it with the
        % same code for Part 1065.
        % set(handles.RatedSpeed,'String',sprintf('%0.1f',handles.SpeedAtPmax));
        set(handles.RatedSpeed,'String',sprintf('%0.1f',handles.MaxTestSpeed));
    end
end
guidata(hObject,handles);

% --- Executes on button press in CreatePlayback.
function CreatePlayback_Callback(hObject, eventdata, handles)
% hObject    handle to CreatePlayback (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Make sure the output directory is a valid directory and disable the
% output directory text box (handles.OutputDirectory) while the playback
% file is being created
set(handles.OutputDirectory,'Enable','off');
if ~verifyOutputDir(handles), return; end
PlaybackOutputDir = get(handles.OutputDirectory,'String');

% Create the playback file
set(handles.CreatePlayback,'Enable','off');
set(handles.lblBusy,'Visible','on');
pause(0.1);
guidata(hObject,handles);

%get a valid file name for the playback
switch handles.Cycle{get(handles.CycleSelecter,'Value')} % Grab the cycle name

    case 'ETC'
        TestType = 'ETC';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.CITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];

    case 'FTP_Diesel'
        TestType = 'FTP-Diesel';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.CITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];

    case 'FTP_Otto'
        TestType = 'FTP-Otto';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.CITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];

    case 'LSINRTC'
        TestType = 'LSINRTC';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.CITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];
               
    case 'NRTC'
        TestType = 'NRTC';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.CITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];

    case 'RMC'
        TestType = 'RMC';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.RMCCITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];
               
    case 'RMCNR'
        TestType = 'RMCNR';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.RMCCITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];
               
    case 'ThirteenM'
        TestType = '13M';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.RMCCITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ];
               
    case 'WHSC'
        TestType = 'WHSC';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.RMCCITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ];             

    case 'WHTC'
        TestType = 'WHTC';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.RMCCITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ...
                   ', CycleLength = ' num2str(handles.CycleLength) ]; 
               
    case 'EightM'
        TestType = '8M';
        SecondLine = ['IdleSpeed = ' get(handles.IdleSpeed,'String')  ...
                   ', IdleTorque = ' get(handles.RMCCITT,'String')  ...
                   ', MaxMappedTorque = ' num2str(handles.MeasMaximumTorque) ...
                   ', MaxMappedPower = ' num2str(handles.MeasMaximumPower) ];
    otherwise
        return
end
[~, PowerCurveName, ~] = fileparts(get(handles.PowerCurvePath,'String'));

% Change the diretory path to the output file path
CurrentDirectory = pwd;
try
    PlaybackFileName = [PlaybackOutputDir '\' PowerCurveName '_' TestType '_PB.txt'];
    cd(PlaybackOutputDir);
catch %#ok<CTCH>
    cd(CurrentDirectory);
    error('MATLAB:CycleMaster:WriteReport','Non conforming file structure Cycle Master couldn''t write report');
    return;
end

% Create file version based on the number of files already in the output
% directory
count = 1;
while exist(PlaybackFileName,'file')
    PlaybackFileName = [PlaybackOutputDir '\' PowerCurveName '_' TestType '_PB_' num2str(count) '.txt'];
    count = count + 1;
end

if get(handles.TenHzPlayback,'Value')
    Writer = cell(length(handles.TenHertzDenormSpeed)+4,14);
    Writer{1,1} = PlaybackFileName;
    Writer{2,1} = SecondLine;
    Writer{3,1} = 'Time';
    Writer{3,2} = 'ECCS Phase';
    Writer{3,3} = 'ECCS Mode';
    Writer{3,4} = 'Speed';
    Writer{3,5} = 'Spd Rate';
    Writer{3,6} = 'Load';
    Writer{3,7} = 'Ld Rate';
    Writer{3,8} = 'Ctrl Mode';
    Writer{3,9} = 'ECCS Soak Mask';
    Writer{3,10} = 'ECCS Run Mask';
    Writer{3,11} = 'Continue Test';
    Writer{3,12} = 'Finish Test';
    Writer{3,13} = 'Throttle %';
    Writer{3,14} = 'Throt Run';

    Writer{4,1} = 'Sec';
    Writer{4,2} = 'N/A';
    Writer{4,3} = 'N/A';
    Writer{4,4} = 'RPM';
    Writer{4,5} = 'RPM/Sec';
    Writer{4,6} = 'Nm';
    Writer{4,7} = 'Nm/Sec';
    Writer{4,8} = 'N/A';
    Writer{4,9} = '-';
    Writer{4,10} = '-';
    Writer{4,11} = '-';
    Writer{4,12} = '-';
    Writer{4,13} = '%';
    Writer{4,14} = '%/Sec';

    Writer(5:end,1) = num2cell((0:length(handles.TenHertzDenormSpeed)-1)'/10);
    Writer(5:end,2) = num2cell(ones(length(handles.TenHertzDenormSpeed),1));
    Writer(5:end,3) = num2cell(handles.TenHertzECCSMode);
    Writer(5:end,4) = num2cell(handles.TenHertzDenormSpeed);
    Writer(5:end,5) = num2cell(str2double(get(handles.SpeedRamp,'String'))*ones(length(handles.TenHertzDenormSpeed),1));
    Writer(5:end,6) = num2cell(handles.TenHertzDenormLoad);
    Writer(5:end,7) = num2cell(str2double(get(handles.LoadRamp,'String'))*ones(length(handles.TenHertzDenormSpeed),1));
    Writer(5:end,8) = num2cell(handles.TenHertzModes);
    Writer(5:end,9) = num2cell(handles.TenHertzECCSSoakMask);
    Writer(5:end,10) = num2cell(handles.TenHertzECCSRunMask);
    Writer(5:end,11) = num2cell(ones(length(handles.TenHertzDenormSpeed),1));
    Writer(5:end,12) = num2cell(zeros(length(handles.TenHertzDenormSpeed),1));
    Writer(5:end,13) = num2cell(zeros(length(handles.TenHertzDenormSpeed),1));
    Writer(5:end,14) = num2cell(100*ones(length(handles.TenHertzDenormSpeed),1));
else
    Writer = cell(length(handles.OneHertzDenormSpeed)+4,14);
    Writer{1,1} = PlaybackFileName;
    Writer{2,1} = SecondLine;
    Writer{3,1} = 'Time';
    Writer{3,2} = 'ECCS Phase';
    Writer{3,3} = 'ECCS Mode';
    Writer{3,4} = 'Speed';
    Writer{3,5} = 'Spd Rate';
    Writer{3,6} = 'Load';
    Writer{3,7} = 'Ld Rate';
    Writer{3,8} = 'Ctrl Mode';
    Writer{3,9} = 'ECCS Soak Mask';
    Writer{3,10} = 'ECCS Run Mask';
    Writer{3,11} = 'Continue Test';
    Writer{3,12} = 'Finish Test';
    Writer{3,13} = 'Throttle %';
    Writer{3,14} = 'Throt Run';

    Writer{4,1} = 'Sec';
    Writer{4,2} = 'N/A';
    Writer{4,3} = 'N/A';
    Writer{4,4} = 'RPM';
    Writer{4,5} = 'RPM/Sec';
    Writer{4,6} = 'Nm';
    Writer{4,7} = 'Nm/Sec';
    Writer{4,8} = 'N/A';
    Writer{4,9} = '-';
    Writer{4,10} = '-';
    Writer{4,11} = '-';
    Writer{4,12} = '-';
    Writer{4,13} = '%';
    Writer{4,14} = '%/Sec';

    Writer(5:end,1) = num2cell((0:length(handles.OneHertzDenormSpeed)-1)');
    Writer(5:end,2) = num2cell(ones(length(handles.OneHertzDenormSpeed),1));
    Writer(5:end,3) = num2cell(handles.OneHertzECCSMode);
    Writer(5:end,4) = num2cell(handles.OneHertzDenormSpeed);
    Writer(5:end,5) = num2cell(str2double(get(handles.SpeedRamp,'String'))*ones(length(handles.OneHertzDenormSpeed),1));
    Writer(5:end,6) = num2cell(handles.OneHertzDenormLoad);
    Writer(5:end,7) = num2cell(str2double(get(handles.LoadRamp,'String'))*ones(length(handles.OneHertzDenormSpeed),1));
    Writer(5:end,8) = num2cell(handles.OneHertzModes);
    Writer(5:end,9) = num2cell(handles.OneHertzECCSSoakMask);
    Writer(5:end,10) = num2cell(handles.OneHertzECCSRunMask);
    Writer(5:end,11) = num2cell(ones(length(handles.OneHertzDenormSpeed),1));
    Writer(5:end,12) = num2cell(ones(length(handles.OneHertzDenormSpeed),1));
    Writer(5:end,13) = num2cell(zeros(length(handles.OneHertzDenormSpeed),1));
    Writer(5:end,14) = num2cell(100*ones(length(handles.OneHertzDenormSpeed),1));
end
[~, handles.PlaybackFileName, ~] = fileparts(PlaybackFileName);
writecsv(PlaybackFileName,Writer,'	');
cd(CurrentDirectory);
WriteReport(handles,PlaybackOutputDir);
set(handles.OutputDirectory,'Enable','on');
set(handles.CreatePlayback,'Enable','on');
set(handles.lblBusy,'Visible','off');
pause(0.1);
guidata(hObject,handles);
msgbox(['Playback ' handles.PlaybackFileName ' created.'],'Cycle Master');


% --- Executes on button press in TenHzPlayback.
function TenHzPlayback_Callback(hObject, eventdata, handles)
% hObject    handle to TenHzPlayback (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hint: get(hObject,'Value') returns toggle state of TenHzPlayback
set(handles.CreatePlayback,'Enable','off');

% --- Executes on button press in CreateCycle.
function CreateCycle_Callback(hObject, eventdata, handles)
% hObject    handle to CreateCycle (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

try
    switch handles.Cycle{get(handles.CycleSelecter,'Value')} % Grab the cycle name

        case 'ETC'
            OneHertzNormCycle = handles.NormETC.OneHertz;
            TenHertzNormCycle = handles.NormETC.TenHertz;
            handles.CycleLength = 1800;

        case 'FTP_Diesel'
            OneHertzNormCycle = handles.NormFTP_Diesel.OneHertz;
            TenHertzNormCycle = handles.NormFTP_Diesel.TenHertz;
            handles.CycleLength = 1199;

        case 'FTP_Otto'
            OneHertzNormCycle = handles.NormFTP_Otto.OneHertz;
            TenHertzNormCycle = handles.NormFTP_Otto.TenHertz;
            handles.CycleLength = 1167;

        case 'LSINRTC'
            OneHertzNormCycle = handles.NormLSINRTC.OneHertz;
            TenHertzNormCycle = handles.NormLSINRTC.TenHertz;
            handles.CycleLength = 1421;
            
        case 'NRTC'
            OneHertzNormCycle = handles.NormNRTC.OneHertz;
            TenHertzNormCycle = handles.NormNRTC.TenHertz;
            handles.CycleLength = 1238;
            
        case 'WHTC'  
            OneHertzNormCycle = handles.NormWHTC.OneHertz;
            TenHertzNormCycle = handles.NormWHTC.TenHertz;
            handles.CycleLength = 1800;

        % The following cycles aren't "normalized" per se and involve
        % special operations - they therefore require outside routines to
        % perform the denormalization

        case 'RMC'
            handles = RMC_Denormalization(handles);
            handles.CycleLength = 2400;
            PlotCycle(handles);
            set(handles.CreatePlayback,'Enable','on');
            guidata(hObject, handles);
            return

        case 'RMCNR'
            handles = RMC_Denormalization(handles);
            handles.CycleLength = 1800;
            PlotCycle(handles);
            set(handles.CreatePlayback,'Enable','on')
            guidata(hObject, handles);
            return

        case 'ThirteenM'
            handles = RMC_Denormalization(handles);
            PlotCycle(handles);
            set(handles.CreatePlayback,'Enable','on');
            guidata(hObject, handles);
            return
                        
        case 'WHSC'
            handles = RMC_Denormalization(handles);
            handles.CycleLength = 1895;
            PlotCycle(handles);
            set(handles.CreatePlayback,'Enable','on');
            guidata(hObject, handles);
            return

        case 'EightM'
            % TBD; not currently available
            return

        otherwise
            return

    end

    % Make sure there is a valid Idle Speed and Rated Speed. Note that the
    % user can enter anything they choose for these values so this is far
    % from foolproof.
    if strcmp(get(handles.IdleSpeed,'String'),'-') || strcmp(get(handles.RatedSpeed,'String'),'-') || ...
        isnan(str2double(get(handles.IdleSpeed,'String'))) || isnan(str2double(get(handles.RatedSpeed,'String')))
        return;
    end

    % Set Curb Idle Transmission Torgue (CITT) to 0 if it hasn't been set
    % to a valid number already
    if strcmp(get(handles.CITT,'String'),'-') || isnan(str2double(get(handles.CITT,'String')))
        set(handles.CITT,'String','0');
    end

    % Set the max speed and idle speed
    MaxSpeed = str2double(get(handles.RatedSpeed,'String'));
    IdleSpeed = str2double(get(handles.IdleSpeed,'String'));
    CITT = str2double(get(handles.CITT,'String'));

    % If the Max Cycle Speed (the 'string' property in handles.SampleBasis)
    % isn't set, set it to twice the maximum speed or if it is set and is
    % less than or equal to the Idle Speed, set it to twice the maximum
    % speed.
    if strcmp(get(handles.SampleBasis,'String'),'-') || isnan(str2double(get(handles.SampleBasis,'String')))
        MaxCycleSpeed = 2*MaxSpeed;
    else
        MaxCycleSpeed = str2double(get(handles.SampleBasis,'String'));
        if MaxCycleSpeed <= IdleSpeed, MaxCycleSpeed = 2*MaxSpeed; end
    end

    % Initialize the "mode" and denormalized torque arrays for 1 and 10 Hz
    % data
    handles.OneHertzModes = zeros(size(OneHertzNormCycle.Load));
    handles.TenHertzModes = zeros(size(TenHertzNormCycle.Load));
    handles.OneHertzDenormLoad = zeros(size(OneHertzNormCycle.Load));
    handles.TenHertzDenormLoad = zeros(size(TenHertzNormCycle.Load));

    % ---------------------------------------------------------------------
    % Calculate "unnormalized" or "denormalized" speeds  
    % ---------------------------------------------------------------------
    
    if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'WHTC')
        % Refer to R049r6e_Annex4, 7.4.6
        handles.OneHertzDenormSpeed = DenormalizeSpeed(OneHertzNormCycle.Speed, handles);
        handles.TenHertzDenormSpeed = DenormalizeSpeed(TenHertzNormCycle.Speed, handles);        
    else
        % Refer to CFR 40.33.1065.610(c)(1) Eq. 1065.610-4 and CFR 40.19.86.133(a)(1)
        if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'FTP_Diesel') && ...
            strcmp(handles.Methodology, 'Part 86')
            handles.OneHertzDenormSpeed = OneHertzNormCycle.Speed*(MaxSpeed-IdleSpeed)/112+IdleSpeed;
            handles.TenHertzDenormSpeed = TenHertzNormCycle.Speed*(MaxSpeed-IdleSpeed)/112+IdleSpeed;
        else
            handles.OneHertzDenormSpeed = OneHertzNormCycle.Speed*(MaxSpeed-IdleSpeed)/100+IdleSpeed;
            handles.TenHertzDenormSpeed = TenHertzNormCycle.Speed*(MaxSpeed-IdleSpeed)/100+IdleSpeed;
        end        
    end
    
    % ---------------------------------------------------------------------
    % Calculate "unnormalized" or "denormalized" torques
    % ---------------------------------------------------------------------

    % Special torque denormalization code for WHTC
    if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'WHTC')
        for k = 1:length(handles.OneHertzDenormSpeed)
            interpTorque = abscissaInterp(handles.PowerCurveTorque, handles.PowerCurveSpeed, handles.OneHertzDenormSpeed(k)); % Can return multiple values    
            interpTorque_length = length(interpTorque);
            if interpTorque_length == 0 % This should be impossible
                error('Denormalization Error! Unable to interpolate torque! Speed, %0.2f RPM, not found!', handles.OneHertzDenormSpeed(k)); % Inside a try-catch and impossible so somewhat pointless
            elseif interpTorque_length > 1
                interpTorque_disp = sprintf('%f, ', interpTorque);
                interpTorque_disp = interpTorque_disp(1:end-2);
                warning('Multiple torque values found at time, %0.1f sec, and speed %0.2f RPM: %s. The maximum value, %0.2f N.m, was used!', k, handles.OneHertzDenormSpeed(k), interpTorque_disp, max(interpTorque));
                handles.OneHertzDenormLoad(k) = max(interpTorque);
            else
                handles.OneHertzDenormLoad(k) = interpTorque;
            end          
        end % k-loop
    else 
        % Used in interpolation below
        min_PowerCurveSpeed = min(handles.PowerCurveSpeed);
        max_PowerCurveSpeed = max(handles.PowerCurveSpeed);

        % Calculate denormalized 1 Hz Torque
        for k = 1:length(handles.OneHertzDenormSpeed)

            % Limits the maximum denormalized speeds with the MaxCycleSpeed
            if (handles.OneHertzDenormSpeed(k) > MaxCycleSpeed), handles.OneHertzDenormSpeed(k) = MaxCycleSpeed; end

            % Use interpolation to calculate the torque based on speed. Make
            % sure that interpolation is possible.
            if handles.OneHertzDenormSpeed(k) < min_PowerCurveSpeed
                interpTorque = abscissaInterp(handles.PowerCurveTorque, handles.PowerCurveSpeed, min_PowerCurveSpeed);
            elseif handles.OneHertzDenormSpeed(k) > max_PowerCurveSpeed
                interpTorque = abscissaInterp(handles.PowerCurveTorque, handles.PowerCurveSpeed, max_PowerCurveSpeed);
            else
            interpTorque = abscissaInterp(handles.PowerCurveTorque, handles.PowerCurveSpeed, handles.OneHertzDenormSpeed(k)); % Can return multiple values
            end

            interpTorque_length = length(interpTorque);

            if interpTorque_length == 0 % This should be impossible
                error('Denormalization Error! Unable to interpolate torque! Speed, %0.2f RPM, not found!', handles.OneHertzDenormSpeed(k)); % Inside a try-catch and impossible so somewhat pointless
            elseif interpTorque_length > 1
                interpTorque_disp = sprintf('%f, ', interpTorque);
                interpTorque_disp = interpTorque_disp(1:end-2);
                if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'WHTC')
                    warning('Multiple torque values found at time, %0.1f sec, and speed %0.2f RPM: %s. The maximum value, %0.2f N.m, was used!', k, handles.OneHertzDenormSpeed(k), interpTorque_disp, max(interpTorque));
                    handles.OneHertzDenormLoad(k) = max(interpTorque);
                else
                    warning('Multiple torque values found at time, %0.1f sec, and speed %0.2f RPM: %s. The first value, %0.2f N.m, was used!', k, handles.OneHertzDenormSpeed(k), interpTorque_disp, interpTorque(1));
                    handles.OneHertzDenormLoad(k) = interpTorque(1);
                end
            else
                handles.OneHertzDenormLoad(k) = interpTorque;
            end 
        end     
    end
    
    % Apply to all cycles
    for k = 1:length(handles.OneHertzDenormSpeed)
        if k <= 3 % 3 seconds
            handles.OneHertzDenormLoad(k) = 0;
            handles.OneHertzModes(k) = str2double(get(handles.SpeedControlMode,'String')); % Engine Crank
        else
            if OneHertzNormCycle.Load(k) == -40 && get(handles.UseFrictionCurve,'Value')
                handles.OneHertzDenormLoad(k) = polyval(handles.FrictionCurveModel,handles.OneHertzDenormSpeed(k));
                handles.OneHertzModes(k) = str2double(get(handles.MotorControlMode,'String'));
            else
                handles.OneHertzDenormLoad(k) = OneHertzNormCycle.Load(k)/100*handles.OneHertzDenormLoad(k);
                if OneHertzNormCycle.Load(k)== -40
                    handles.OneHertzModes(k) = str2double(get(handles.MotorControlMode,'String'));
                else
                    handles.OneHertzModes(k) = str2double(get(handles.SpeedControlMode,'String'));
                end
            end
            if handles.OneHertzDenormSpeed(k) == IdleSpeed && handles.OneHertzDenormLoad(k) <= CITT && ~(OneHertzNormCycle.Load(k) == -40)
                handles.OneHertzModes(k) = str2double(get(handles.IdleControlMode,'String'));
                handles.OneHertzDenormLoad(k) = CITT;
                if k <= 24
                    handles.OneHertzDenormLoad(k) = 0;
                end
            end
        end        
    end
    
    % Create the 10 Hz denormalized load from the 1 Hz data
    [~, handles.TenHertzDenormLoad] = convertTo10Hz([0:1:length(handles.OneHertzDenormSpeed)-1]', handles.OneHertzDenormLoad);

    % Calculate denormalized 10 Hz Torque
    for k = 1:length(handles.TenHertzDenormSpeed)

        if k <= 31 % 3 seconds
            handles.TenHertzDenormLoad(k) = 0;
            handles.TenHertzModes(k) = str2double(get(handles.SpeedControlMode,'String'));
        else
            if TenHertzNormCycle.Load(k) == -40 && get(handles.UseFrictionCurve,'Value')
                handles.TenHertzDenormLoad(k) = polyval(handles.FrictionCurveModel,handles.TenHertzDenormSpeed(k));
                handles.TenHertzModes(k) = str2double(get(handles.MotorControlMode,'String'));
            else
                %handles.TenHertzDenormLoad(k) = TenHertzNormCycle.Load(k)/100*handles.TenHertzDenormLoad(k);
                if TenHertzNormCycle.Load(k) <= -0.1 % EDS - Why isn't this -40 like above???
                    handles.TenHertzModes(k) = str2double(get(handles.MotorControlMode,'String'));
                else
                    handles.TenHertzModes(k) = str2double(get(handles.SpeedControlMode,'String'));
                end
            end
            if handles.TenHertzDenormSpeed(k) == IdleSpeed && handles.TenHertzDenormLoad(k) <= CITT && ~(TenHertzNormCycle.Load(k) <= -0.1)
                handles.TenHertzModes(k) = str2double(get(handles.IdleControlMode,'String'));
                handles.TenHertzDenormLoad(k) = CITT;
                if k <= 241 % 24 seconds
                    handles.TenHertzDenormLoad(k) = 0;
                end
                if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')},'FTP_Diesel') || strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')},'NRTC') % FTP/NRTC ramp to CITT
                    if ( k > 241 ) && ( k <= 251 ) % defines the interval (24 sec, 25 sec]
                        handles.TenHertzDenormLoad(k) = CITT*(k-241)/10;
                    end
                end
            end
        end
    end

    handles.OneHertzECCSMode = ones(length(handles.OneHertzDenormSpeed),1);
    handles.OneHertzECCSSoakMask = zeros(length(handles.OneHertzDenormSpeed),1);
    handles.OneHertzECCSRunMask = ones(length(handles.OneHertzDenormSpeed),1);

    handles.TenHertzECCSMode = ones(length(handles.TenHertzDenormSpeed),1);
    handles.TenHertzECCSSoakMask = zeros(length(handles.TenHertzDenormSpeed),1);
    handles.TenHertzECCSRunMask = ones(length(handles.TenHertzDenormSpeed),1);

    set(handles.CreatePlayback,'Enable','on');
    guidata(hObject, handles);
    PlotCycle(handles);
catch %#ok
    msgbox('Cycle generation was unsuccessful. Please check that all necessary data is provided.','Cycle Master');
end

% --- Executes on button press in CreateTrace.
function CreateTrace_Callback(hObject, eventdata, handles)
% hObject    handle to CreateTrace (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

function RatedSpeed_Callback(hObject, eventdata, handles)
% hObject    handle to RatedSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RatedSpeed as text
%        str2double(get(hObject,'String')) returns contents of RatedSpeed as a double
set(handles.CreatePlayback,'Enable','off');

function CITT_Callback(hObject, eventdata, handles)
% hObject    handle to CITT (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of CITT as text
%        str2double(get(hObject,'String')) returns contents of CITT as a double

set(handles.CreatePlayback,'Enable','off');

function IdleSpeed_Callback(hObject, eventdata, handles)
% hObject    handle to IdleSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of IdleSpeed as text
%        str2double(get(hObject,'String')) returns contents of IdleSpeed as a double
set(handles.CreatePlayback,'Enable','off');

% --- Executes on button press in PlotSumSquares.
function PlotSumSquares_Callback(hObject, eventdata, handles)
% hObject    handle to PlotSumSquares (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hint: get(hObject,'Value') returns toggle state of PlotSumSquares
cla(handles.PowerCurveAxes,'reset');
cla(handles.TorqueCurveAxes,'reset');
if ~get(hObject,'Value')
    set(handles.PlotSumSquares,'String','Plot Sum of Squares');
    set(handles.PowerCurveAxes,'Visible','on');
    plot(handles.TorqueCurveAxes, handles.PowerCurveSpeed, handles.PowerCurveTorque);
    plot(handles.PowerCurveAxes,handles.PowerCurveSpeed, handles.PowerCurvePower,'r');
    set(handles.PowerCurveAxes,'YAxisLocation','right' ...
                              ,'XAxisLocation','top' ...
                              ,'XTickLabel','' ...
                              ,'Box','off' ...
                              ,'YColor','r');
    set(handles.TorqueCurveAxes,'Color','none' ...
                               ,'YColor','b' ...
                               ,'Box','off');
    xlabel(handles.TorqueCurveAxes,'Engine Speed (RPM)');
    ylabel(handles.TorqueCurveAxes,'Torque (N.m)');
    ylabel(handles.PowerCurveAxes,'Power (kW)');
else
    set(handles.PlotSumSquares,'String','Plot Torque & Power');
    set(handles.PowerCurveAxes,'Visible','off');
    plot(handles.TorqueCurveAxes, handles.PowerCurveSpeed, handles.sumSquares);
    set(handles.TorqueCurveAxes,'Box','on');
    ylabel(handles.TorqueCurveAxes,'Sum of Squares');
    xlabel(handles.TorqueCurveAxes,'Engine Speed (RPM)');
end
guidata(hObject,handles);

function SpeedRamp_Callback(hObject, eventdata, handles)
% hObject    handle to SpeedRamp (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of SpeedRamp as text
%        str2double(get(hObject,'String')) returns contents of SpeedRamp as a double
set(handles.CreatePlayback,'Enable','off');

function LoadRamp_Callback(hObject, eventdata, handles)
% hObject    handle to LoadRamp (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of LoadRamp as text
%        str2double(get(hObject,'String')) returns contents of LoadRamp as a double
set(handles.CreatePlayback,'Enable','off');

function HideAllOptions(handles)
HideStandardTransientOptions(handles);
HideRMCOptions(handles);
Hide8MOptions(handles);
HideWHOptions(handles);
set(handles.SampleBasis,'Visible','off');
set(handles.optSampleBasis,'Visible','off');
set(handles.optSampleBasis,'String','Sample per 1% (s)');

function ShowStandardTransientOptions(handles)
set(handles.UseFrictionCurve,'Visible','on');
set(handles.UsePart1065Method,'Visible','on');
set(handles.optIdleSpeed,'Visible','on');
set(handles.optRatedSpeed,'Visible','on');
set(handles.optCITT,'Visible','on');
set(handles.IdleSpeed,'Visible','on');
set(handles.IdleSpeed,'Enable','on');
set(handles.RatedSpeed,'Visible','on');
set(handles.RatedSpeed,'Enable','on');
set(handles.CITT,'Visible','on');
set(handles.CITT,'Enable','on');
isFTP = strfind(handles.Cycle{get(handles.CycleSelecter,'Value')},'FTP');
if ~isempty(isFTP)
    set(handles.UsePart1065Method,'Enable','off'); 
    set(handles.UsePart1065Method,'Value', 0.0);
else
    set(handles.UsePart1065Method,'Enable','on'); 
    set(handles.UsePart1065Method,'Value', 1.0);
end

function HideStandardTransientOptions(handles)
set(handles.UseFrictionCurve,'Visible','off');
set(handles.UseFrictionCurve,'Enable','off');
set(handles.UsePart1065Method,'Visible','off');
set(handles.optIdleSpeed,'Visible','off');
set(handles.optRatedSpeed,'Visible','off');
set(handles.optCITT,'Visible','off');
set(handles.IdleSpeed,'Visible','off');
set(handles.IdleSpeed,'Enable','off');
set(handles.RatedSpeed,'Visible','off');
set(handles.RatedSpeed,'Enable','off');
set(handles.CITT,'Visible','off');
set(handles.CITT,'Enable','off');
set(handles.UsePart1065Method,'Enable','off'); 
set(handles.UsePart1065Method,'Value', 0.0);

function ShowRMCOptions(handles)
set(handles.optRMCCSpeed,'Visible','on'); % C Speed
set(handles.optRMCBSpeed,'Visible','on'); % B Speed
set(handles.optRMCASpeed,'Visible','on'); % A Speed
set(handles.optRMCCITT,'Visible','on'); % CITT (N.m)
set(handles.optRMCIdleSpeed,'Visible','on'); % Idle Speed (RPM)
set(handles.RMCIdleSpeed,'Visible','on');
set(handles.RMCIdleSpeed,'Enable','on');
set(handles.RMCCITT,'Visible','on');
set(handles.RMCCITT,'Enable','on');
set(handles.RMCASpeed,'Visible','on');
set(handles.RMCASpeed,'Enable','on');
set(handles.RMCBSpeed,'Visible','on');
set(handles.RMCBSpeed,'Enable','on');
set(handles.RMCCSpeed,'Visible','on');
set(handles.RMCCSpeed,'Enable','on');

function HideRMCOptions(handles)
set(handles.optRMCCSpeed,'Visible','off'); % C Speed
set(handles.optRMCBSpeed,'Visible','off'); % B Speed
set(handles.optRMCASpeed,'Visible','off'); % A Speed
set(handles.optRMCCITT,'Visible','off'); % CITT (N.m)
set(handles.optRMCIdleSpeed,'Visible','off'); % Idle Speed (RPM)
set(handles.RMCIdleSpeed,'Visible','off');
set(handles.RMCIdleSpeed,'Enable','off');
set(handles.RMCCITT,'Visible','off');
set(handles.RMCCITT,'Enable','off');
set(handles.RMCASpeed,'Visible','off');
set(handles.RMCASpeed,'Enable','off');
set(handles.RMCBSpeed,'Visible','off');
set(handles.RMCBSpeed,'Enable','off');
set(handles.RMCCSpeed,'Visible','off');
set(handles.RMCCSpeed,'Enable','off');;

function ShowRMCNROptions(handles)
set(handles.optRMCIdleSpeed,'Visible','on'); % Idle Speed (RPM)
set(handles.optRMCCITT,'Visible','on'); % CITT (N.m)
set(handles.optRMCASpeed,'String','Rated Speed (RPM)')
set(handles.optRMCASpeed,'Visible','on') % Rated Speed (RPM)
set(handles.optRMCBSpeed,'String','Int. Speed (RPM)')
set(handles.optRMCBSpeed,'Visible','on') % Int. Speed (RPM)
set(handles.RMCIdleSpeed,'Visible','on');
set(handles.RMCIdleSpeed,'Enable','on');
set(handles.RMCCITT,'Visible','on');
set(handles.RMCCITT,'Enable','on');
if ~strcmp(get(handles.RMCASpeed,'String'),'-')
    set(handles.RMCASpeed,'String',sprintf('%0.1f',handles.SpeedAtPmax));
end
set(handles.RMCASpeed,'Visible','on');
set(handles.RMCASpeed,'Enable','on');
if ~strcmp(get(handles.RMCBSpeed,'String'),'-')
    set(handles.RMCBSpeed,'String',sprintf('%0.1f',handles.MeasIntermediateSpeed));
end
set(handles.RMCBSpeed,'Visible','on');
set(handles.RMCBSpeed,'Enable','on');

function HideRMCNROptions(handles)
set(handles.optRMCIdleSpeed,'Visible','off');
set(handles.optRMCCITT,'Visible','off');
set(handles.optRMCASpeed,'Visible','off');
set(handles.optRMCASpeed,'String','A Speed (RPM)');
set(handles.optRMCBSpeed,'Visible','off');
set(handles.optRMCBSpeed,'String','B Speed (RPM)');
set(handles.RMCIdleSpeed,'Visible','off');
set(handles.RMCIdleSpeed,'Enable','off');
set(handles.RMCCITT,'Visible','off');
set(handles.RMCCITT,'Enable','off');
if ~strcmp(get(handles.RMCASpeed,'String'),'-')
    set(handles.RMCASpeed,'String',sprintf('%0.1f',handles.MeasASpeed));
end
set(handles.RMCASpeed,'Visible','off');
set(handles.RMCASpeed,'Enable','off');
if ~strcmp(get(handles.RMCBSpeed,'String'),'-')
    set(handles.RMCBSpeed,'String',sprintf('%0.1f',handles.MeasBSpeed));
end
set(handles.RMCBSpeed,'Visible','off');
set(handles.RMCBSpeed,'Enable','off');

function Show8MOptions(handles)
ShowRMCNROptions(handles);
set(handles.optRMCCSpeed,'String','Sample per 1% (s)');
set(handles.optRMCCSpeed,'Visible','on'); % Sample per 1% (s)
if ~strcmp(get(handles.RMCCSpeed,'String'),'-')
    set(handles.RMCCSpeed,'String',' - '); % clever hack to prevent resetting c speed... don't change this or you will regret it!
end
set(handles.RMCCSpeed,'Visible','on');
set(handles.RMCCSpeed,'Enable','on');

function Hide8MOptions(handles)
HideRMCNROptions(handles)
set(handles.optRMCCSpeed,'Visible','off'); % Sample per 1% (s); changed below
set(handles.optRMCCSpeed,'String','C Speed (RPM)');
if ~strcmp(get(handles.RMCCSpeed,'String'),'-')
    set(handles.RMCCSpeed,'String',sprintf('%0.1f',handles.MeasCSpeed));
end
set(handles.RMCCSpeed,'Visible','off');
set(handles.RMCCSpeed,'Enable','off');

function ShowWHOptions(handles)
set(handles.lblWHIdleSpeed,'Visible','on');
set(handles.WHIdleSpeed,'Visible','on');
set(handles.WHIdleSpeed,'Enable','on');
set(handles.lblNlo,'Visible','on');
set(handles.WHnlo,'Visible','on');
set(handles.WHnlo,'Enable','on');
set(handles.lblNpref,'Visible','on');
set(handles.WHnpref,'Visible','on');
set(handles.WHnpref,'Enable','on');
set(handles.lblN95h,'Visible','on');
set(handles.WHn95h,'Visible','on');
set(handles.WHn95h,'Enable','off');
set(handles.lblNhi,'Visible','on');
set(handles.WHnhi,'Visible','on');
set(handles.WHnhi,'Enable','on');

function HideWHOptions(handles)
set(handles.lblWHIdleSpeed,'Visible','off');
set(handles.WHIdleSpeed,'Visible','off');
set(handles.WHIdleSpeed,'Enable','off');
set(handles.lblNlo,'Visible','off');
set(handles.WHnlo,'Visible','off');
set(handles.WHnlo,'Enable','off');
set(handles.lblNpref,'Visible','off');
set(handles.WHnpref,'Visible','off');
set(handles.WHnpref,'Enable','off');
set(handles.lblN95h,'Visible','off');
set(handles.WHn95h,'Visible','off');
set(handles.WHn95h,'Enable','off');
set(handles.lblNhi,'Visible','off');
set(handles.WHnhi,'Visible','off');
set(handles.WHnhi,'Enable','off');

function RMCIdleSpeed_Callback(hObject, eventdata, handles)
% hObject    handle to RMCIdleSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RMCIdleSpeed as text
%        str2double(get(hObject,'String')) returns contents of RMCIdleSpeed as a double
set(handles.CreatePlayback,'Enable','off');

function RMCCITT_Callback(hObject, eventdata, handles)
% hObject    handle to RMCCITT (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RMCCITT as text
%        str2double(get(hObject,'String')) returns contents of RMCCITT as a double
set(handles.CreatePlayback,'Enable','off');

function RMCASpeed_Callback(hObject, eventdata, handles)
% hObject    handle to RMCASpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RMCASpeed as text
%        str2double(get(hObject,'String')) returns contents of RMCASpeed as a double
set(handles.CreatePlayback,'Enable','off');

function RMCBSpeed_Callback(hObject, eventdata, handles)
% hObject    handle to RMCBSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RMCBSpeed as text
%        str2double(get(hObject,'String')) returns contents of RMCBSpeed as a double
set(handles.CreatePlayback,'Enable','off');

function RMCCSpeed_Callback(hObject, eventdata, handles)
% hObject    handle to RMCCSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of RMCCSpeed as text
%        str2double(get(hObject,'String')) returns contents of RMCCSpeed as a double
set(handles.CreatePlayback,'Enable','off');

function WHIdleSpeed_Callback(hObject, eventdata, handles)
% hObject    handle to WHIdleSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of WHIdleSpeed as text
%        str2double(get(hObject,'String')) returns contents of WHIdleSpeed as a double

function WHnlo_Callback(hObject, eventdata, handles)
% hObject    handle to WHnlo (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of WHnlo as text
%        str2double(get(hObject,'String')) returns contents of WHnlo as a double

function WHnpref_Callback(hObject, eventdata, handles)
% hObject    handle to WHnpref (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of WHnpref as text
%        str2double(get(hObject,'String')) returns contents of WHnpref as a double

function WHn95h_Callback(hObject, eventdata, handles)
% hObject    handle to WHn95h (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of WHn95h as text
%        str2double(get(hObject,'String')) returns contents of WHn95h as a double

function WHnhi_Callback(hObject, eventdata, handles)
% hObject    handle to WHnhi (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of WHnhi as text
%        str2double(get(hObject,'String')) returns contents of WHnhi as a double

function denormSpeed = DenormalizeSpeed(pctspeed, handles)
    WH_Nidle = str2double(get(handles.WHIdleSpeed,'String'));
    WH_Nlo = str2double(get(handles.WHnlo,'String'));
    WH_Nhi = str2double(get(handles.WHnhi,'String'));
    WH_Npref = str2double(get(handles.WHnpref,'String'));
    
    denormSpeed = pctspeed/100 * (0.45 * WH_Nlo + ...
    0.45 * WH_Npref + 0.1 * WH_Nhi - WH_Nidle) * 2.0327 + ...
    WH_Nidle;

function interpolatedTorque = InterpolateTorque(handles, denormspeed)
    interpTorque = abscissaInterp(handles.PowerCurveTorque, handles.PowerCurveSpeed, denormspeed); % Can return multiple values    
    interpTorque_length = length(interpTorque);
    if interpTorque_length == 0 % This should be impossible
        error('Denormalization Error! Unable to interpolate torque! Speed, %0.2f RPM, not found!', denormspeed); % Inside a try-catch and impossible so somewhat pointless
    elseif interpTorque_length > 1
        interpTorque_disp = sprintf('%f, ', interpTorque);
        interpTorque_disp = interpTorque_disp(1:end-2);
        warning('Multiple torque values found at speed %0.2f RPM: %s. The maximum value, %0.2f N.m, was used!', denormspeed, interpTorque_disp, max(interpTorque));
        interpolatedTorque = max(interpTorque);
    else
        interpolatedTorque = interpTorque;
    end     

function PlotCycle(handles)
plot(handles.SpeedCycleAxes, handles.OneHertzDenormSpeed);
plot(handles.LoadCycleAxes, handles.OneHertzDenormLoad,'r');
set(handles.LoadCycleAxes,'YAxisLocation','right' ...
                          ,'XAxisLocation','top' ...
                          ,'XTickLabel','' ...
                          ,'Box','off' ...
                          ,'YColor','r');
set(handles.SpeedCycleAxes,'Color','none' ...
                           ,'YColor','b' ...
                           ,'Box','off');
SpeedLim = get(handles.SpeedCycleAxes,'YLim');
LoadLim = get(handles.LoadCycleAxes,'YLim');
DeltaSpeed = SpeedLim(2)-SpeedLim(1);
DeltaLoad = LoadLim(2)-LoadLim(1);
SpeedLim(1) = SpeedLim(1)-DeltaSpeed;
LoadLim(2) = LoadLim(2)+DeltaLoad;
set(handles.SpeedCycleAxes,'Ylim',SpeedLim);
set(handles.LoadCycleAxes,'YLim',LoadLim);
xlabel(handles.SpeedCycleAxes,'Time (s)');
ylabel(handles.SpeedCycleAxes,'Engine Speed (RPM)');
ylabel(handles.LoadCycleAxes,'Torque (N.m)');

function handles = RMC_Denormalization(handles)

if ~strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')},'WHSC') && (strcmp(get(handles.RMCIdleSpeed,'String'),'-') || strcmp(get(handles.RMCASpeed,'String'),'-') ...
        || strcmp(get(handles.RMCBSpeed,'String'),'-') || strcmp(get(handles.RMCCSpeed,'String'),'-'))
    return;
end

if strcmp(get(handles.RMCCITT,'String'),'-')
    set(handles.RMCCITT,'String','0');
end

ModeSwitching = 0;

switch  handles.Cycle{get(handles.CycleSelecter,'Value')} % Grab the cycle name

    case 'RMC'
        NormData = handles.NormRMC;
        IdleSpeed = str2double(get(handles.RMCIdleSpeed,'String'));
        CITT = 0;
        ASpeed = str2double(get(handles.RMCASpeed,'String'));
        BSpeed = str2double(get(handles.RMCBSpeed,'String'));
        CSpeed = str2double(get(handles.RMCCSpeed,'String'));

        ALoad = 0;
        BLoad = 0;
        CLoad = 0;

        for k = 1:length(handles.PowerCurveSpeed)
            if handles.PowerCurveSpeed(k) >= ASpeed && ALoad == 0
                ALoad = handles.PowerCurveTorque(k);
            end
            if handles.PowerCurveSpeed(k) >= BSpeed && BLoad == 0
                BLoad = handles.PowerCurveTorque(k);
            end
            if handles.PowerCurveSpeed(k) >= CSpeed && CLoad == 0
                CLoad = handles.PowerCurveTorque(k);
                break;
            end
        end

    case 'RMCNR'
        NormData = handles.NormRMCNR;
        IdleSpeed = str2double(get(handles.RMCIdleSpeed,'String'));
        CITT = str2double(get(handles.RMCCITT,'String'));
        MaxTestSpeed = str2double(get(handles.RMCASpeed,'String'));
        IntermediateSpeed = str2double(get(handles.RMCBSpeed,'String'));

        MaxSpeedLoad = 0;
        IntermediateLoad = 0;

        for k = 1:length(handles.PowerCurveSpeed)
            if handles.PowerCurveSpeed(k) >= IntermediateSpeed && IntermediateLoad == 0
                IntermediateLoad = handles.PowerCurveTorque(k);
            end
            if handles.PowerCurveSpeed(k) >= MaxTestSpeed && MaxSpeedLoad == 0
                MaxSpeedLoad = handles.PowerCurveTorque(k);
                break;
            end
        end

    case 'ThirteenM'
        NormData = handles.Norm13M;
        ModeSwitching = 1;
        if strcmp(get(handles.SampleBasis,'String'),'-'), return; end;
        IdleSpeed = str2double(get(handles.RMCIdleSpeed,'String'));
        CITT = 0;
        ASpeed = str2double(get(handles.RMCASpeed,'String'));
        BSpeed = str2double(get(handles.RMCBSpeed,'String'));
        CSpeed = str2double(get(handles.RMCCSpeed,'String'));

        ALoad = 0;
        BLoad = 0;
        CLoad = 0;

        for k = 1:length(handles.PowerCurveSpeed)
            if handles.PowerCurveSpeed(k) >= ASpeed && ALoad == 0
                ALoad = handles.PowerCurveTorque(k);
            end
            if handles.PowerCurveSpeed(k) >= BSpeed && BLoad == 0
                BLoad = handles.PowerCurveTorque(k);
            end
            if handles.PowerCurveSpeed(k) >= CSpeed && CLoad == 0
                CLoad = handles.PowerCurveTorque(k);
                break;
            end
        end
        SampleBasis = str2double(get(handles.SampleBasis,'String'));
        if SampleBasis > 10, SampleBasis = 10; end
        if SampleBasis <  4, SampleBasis =  4; end
        
    case 'WHSC'
        NormData = handles.NormWHSC;

    case 'EightM'
        NormData = handles.Norm8M;
        ModeSwitching = 1;
        SampleBasis = str2double(get(handles.EightModeSampleBasis,'String'));
    otherwise
        %Is this even possible?
        return
end

duration = sum([NormData{:,2}]);

handles.OneHertzDenormSpeed = zeros(duration,1);
handles.OneHertzDenormLoad = zeros(duration,1);
handles.OneHertzECCSMode = zeros(duration,1);
handles.OneHertzECCSSoakMask = zeros(duration,1);
handles.OneHertzECCSRunMask = zeros(duration,1);
handles.OneHertzModes = zeros(duration,1);

handles.TenHertzDenormSpeed = zeros(duration*10,1);
handles.TenHertzDenormLoad = zeros(duration*10,1);
handles.TenHertzECCSMode = zeros(duration*10,1);
handles.TenHertzECCSSoakMask = zeros(duration*10,1);
handles.TenHertzECCSRunMask = zeros(duration*10,1);
handles.TenHertzModes = zeros(duration*10,1);

OneHertzPosition = 1;
TenHertzPosition = 1;
ModeNumber = 1;
for k = 1:length(NormData)
    if strcmp(NormData{k,1},'Steady-state')
        switch NormData{k,3}
            case 'Warm Idle'
                Speed = IdleSpeed;
                Load = CITT;
                ControlMode = str2double(get(handles.IdleControlMode,'String'));
            case 'A'
                Speed = ASpeed;
                Load = ALoad/100*NormData{k,4};
                ControlMode = str2double(get(handles.SpeedControlMode,'String'));
            case 'B'
                Speed = BSpeed;
                Load = BLoad/100*NormData{k,4};
                ControlMode = str2double(get(handles.SpeedControlMode,'String'));
            case 'C'
                Speed = CSpeed;
                Load = CLoad/100*NormData{k,4};
                ControlMode = str2double(get(handles.SpeedControlMode,'String'));
            case 'Intermediate Speed'
                Speed = IntermediateSpeed;
                Load = IntermediateLoad/100*NormData{k,4};
                ControlMode = str2double(get(handles.SpeedControlMode,'String'));
            case 'Maximum Test Speed'
                Speed = MaxTestSpeed;
                Load = MaxSpeedLoad/100*NormData{k,4};
                ControlMode = str2double(get(handles.SpeedControlMode,'String'));
            otherwise % WHSC specific
                if isnumeric(NormData{k,3}) && isnumeric(NormData{k,4})
                    Speed = DenormalizeSpeed(NormData{k,3}, handles);                             
                    Load = NormData{k,4}/100 * InterpolateTorque(handles, Speed);
                    ControlMode = str2double(get(handles.SpeedControlMode,'String'));
                end
        end
        if ModeSwitching
            ModeDuration = NormData{k,5}*100*SampleBasis;
            if isempty(ModeDuration), ModeDuration = 0; end
        end

        if k == 1 % T = 0
            handles.OneHertzDenormSpeed(OneHertzPosition) = Speed;
            handles.OneHertzDenormLoad(OneHertzPosition) = Load;
            handles.TenHertzDenormSpeed(TenHertzPosition) = Speed;
            handles.TenHertzDenormLoad(TenHertzPosition) = Load;
            if ModeSwitching
                if 0 >= (NormData{k,2}-ModeDuration)
                    handles.OneHertzECCSMode(OneHertzPosition) = ModeNumber;
                    handles.OneHertzECCSSoakMask(OneHertzPosition) = 0;
                    handles.OneHertzECCSRunMask(OneHertzPosition) = 1;
                    handles.OneHertzModes(OneHertzPosition) = ControlMode;
                    handles.TenHertzECCSMode(TenHertzPosition) = ModeNumber;
                    handles.TenHertzECCSSoakMask(TenHertzPosition) = 0;
                    handles.TenHertzECCSRunMask(TenHertzPosition) = 1;
                    handles.TenHertzModes(TenHertzPosition) = ControlMode;
                else
                    handles.OneHertzECCSMode(OneHertzPosition) = ModeNumber;
                    handles.OneHertzECCSSoakMask(OneHertzPosition) = 1;
                    handles.OneHertzECCSRunMask(OneHertzPosition) = 0;
                    handles.OneHertzModes(OneHertzPosition) = ControlMode;
                    handles.TenHertzECCSMode(TenHertzPosition) = ModeNumber;
                    handles.TenHertzECCSSoakMask(TenHertzPosition) = 1;
                    handles.TenHertzECCSRunMask(TenHertzPosition) = 0;
                    handles.TenHertzModes(TenHertzPosition) = ControlMode;
                end
            else
                handles.OneHertzECCSMode(OneHertzPosition) = 1;
                handles.OneHertzECCSSoakMask(OneHertzPosition) = 0;
                handles.OneHertzECCSRunMask(OneHertzPosition) = 1;
                handles.OneHertzModes(OneHertzPosition) = ControlMode;
                handles.TenHertzECCSMode(TenHertzPosition) = 1;
                handles.TenHertzECCSSoakMask(TenHertzPosition) = 0;
                handles.TenHertzECCSRunMask(TenHertzPosition) = 1;
                handles.TenHertzModes(TenHertzPosition) = ControlMode;
            end
            OneHertzPosition = OneHertzPosition + 1;
            TenHertzPosition = TenHertzPosition + 1;
        end

        for m = 1:NormData{k,2}

            %1 Hz
            handles.OneHertzDenormSpeed(OneHertzPosition) = Speed;
            handles.OneHertzDenormLoad(OneHertzPosition) = Load;
            if ModeSwitching
                if m >= (NormData{k,2}-ModeDuration)
                    handles.OneHertzECCSMode(OneHertzPosition) = ModeNumber;
                    handles.OneHertzECCSSoakMask(OneHertzPosition) = 0;
                    handles.OneHertzECCSRunMask(OneHertzPosition) = 1;
                    handles.OneHertzModes(OneHertzPosition) = ControlMode;
                else
                    handles.OneHertzECCSMode(OneHertzPosition) = ModeNumber;
                    handles.OneHertzECCSSoakMask(OneHertzPosition) = 1;
                    handles.OneHertzECCSRunMask(OneHertzPosition) = 0;
                    handles.OneHertzModes(OneHertzPosition) = ControlMode;
                end
            else
                handles.OneHertzECCSMode(OneHertzPosition) = 1;
                handles.OneHertzECCSSoakMask(OneHertzPosition) = 0;
                handles.OneHertzECCSRunMask(OneHertzPosition) = 1;
                handles.OneHertzModes(OneHertzPosition) = ControlMode;
            end

            %10 Hz
            for n = 1:10
                handles.TenHertzDenormSpeed(TenHertzPosition) = Speed;
                handles.TenHertzDenormLoad(TenHertzPosition) = Load;
                if ModeSwitching
                    if (m+n/10-1) > (NormData{k,2}-ModeDuration)
                        handles.TenHertzECCSMode(TenHertzPosition) = ModeNumber;
                        handles.TenHertzECCSSoakMask(TenHertzPosition) = 0;
                        handles.TenHertzECCSRunMask(TenHertzPosition) = 1;
                        handles.TenHertzModes(TenHertzPosition) = ControlMode;
                    else
                        handles.TenHertzECCSMode(TenHertzPosition) = ModeNumber;
                        handles.TenHertzECCSSoakMask(TenHertzPosition) = 1;
                        handles.TenHertzECCSRunMask(TenHertzPosition) = 0;
                        handles.TenHertzModes(TenHertzPosition) = ControlMode;
                    end
                else
                    handles.TenHertzECCSMode(TenHertzPosition) = 1;
                    handles.TenHertzECCSSoakMask(TenHertzPosition) = 0;
                    handles.TenHertzECCSRunMask(TenHertzPosition) = 1;
                    handles.TenHertzModes(TenHertzPosition) = ControlMode;
                end
                TenHertzPosition = TenHertzPosition + 1;
            end
            OneHertzPosition = OneHertzPosition + 1;
        end
        ModeNumber = ModeNumber+1;
    else %Transition
        ControlMode = str2double(get(handles.SpeedControlMode,'String'));
        switch NormData{k-1,3}
            case 'Warm Idle'
                LastSpeed = IdleSpeed;
                LastLoad = CITT;
            case 'A'
                LastSpeed = ASpeed;
                LastLoad = ALoad/100*NormData{k-1,4};
            case 'B'
                LastSpeed = BSpeed;
                LastLoad = BLoad/100*NormData{k-1,4};
            case 'C'
                LastSpeed = CSpeed;
                LastLoad = CLoad/100*NormData{k-1,4};
            case 'Intermediate Speed'
                LastSpeed = IntermediateSpeed;
                LastLoad = IntermediateLoad/100*NormData{k-1,4};
            case 'Maximum Test Speed'
                LastSpeed = MaxTestSpeed;
                LastLoad = MaxSpeedLoad/100*NormData{k-1,4};
            otherwise % WHSC specific
                if isnumeric(NormData{k-1,3}) && isnumeric(NormData{k-1,4})
                    LastSpeed = DenormalizeSpeed(NormData{k-1,3}, handles);                             
                    LastLoad = NormData{k-1,4}/100 * InterpolateTorque(handles, LastSpeed);
                end
        end
        switch NormData{k+1,3}
            case 'Warm Idle'
                NextSpeed = IdleSpeed;
                NextLoad = CITT;
            case 'A'
                NextSpeed = ASpeed;
                NextLoad = ALoad/100*NormData{k+1,4};
            case 'B'
                NextSpeed = BSpeed;
                NextLoad = BLoad/100*NormData{k+1,4};
            case 'C'
                NextSpeed = CSpeed;
                NextLoad = CLoad/100*NormData{k+1,4};
            case 'Intermediate Speed'
                NextSpeed = IntermediateSpeed;
                NextLoad = IntermediateLoad/100*NormData{k+1,4};
            case 'Maximum Test Speed'
                NextSpeed = MaxTestSpeed;
                NextLoad = MaxSpeedLoad/100*NormData{k+1,4};
            otherwise % WHSC specific
                if isnumeric(NormData{k+1,3}) && isnumeric(NormData{k+1,4})
                    NextSpeed = DenormalizeSpeed(NormData{k+1,3}, handles);                             
                    NextLoad = NormData{k+1,4}/100 * InterpolateTorque(handles, NextSpeed);
                end
        end
        for m = 1:NormData{k,2}
            handles.OneHertzDenormSpeed(OneHertzPosition) = LastSpeed+m/NormData{k,2}*(NextSpeed-LastSpeed);
            handles.OneHertzDenormLoad(OneHertzPosition) = LastLoad+m/NormData{k,2}*(NextLoad-LastLoad);

            if ModeSwitching
                handles.OneHertzECCSMode(OneHertzPosition) = ModeNumber;
                handles.OneHertzECCSSoakMask(OneHertzPosition) = 1;
                handles.OneHertzECCSRunMask(OneHertzPosition) = 0;
                handles.OneHertzModes(OneHertzPosition) = ControlMode;
            else
                handles.OneHertzECCSMode(OneHertzPosition) = 1;
                handles.OneHertzECCSSoakMask(OneHertzPosition) = 0;
                handles.OneHertzECCSRunMask(OneHertzPosition) = 1;
                handles.OneHertzModes(OneHertzPosition) = ControlMode;
            end
            for n = 1:10
                handles.TenHertzDenormSpeed(TenHertzPosition) = LastSpeed+(m+n/10-1)/NormData{k,2}*(NextSpeed-LastSpeed);
                handles.TenHertzDenormLoad(TenHertzPosition) = LastLoad+(m+n/10-1)/NormData{k,2}*(NextLoad-LastLoad);
                if ModeSwitching
                    handles.TenHertzECCSMode(TenHertzPosition) = ModeNumber;
                    handles.TenHertzECCSSoakMask(TenHertzPosition) = 1;
                    handles.TenHertzECCSRunMask(TenHertzPosition) = 0;
                    handles.TenHertzModes(TenHertzPosition) = ControlMode;
                else
                    handles.TenHertzECCSMode(TenHertzPosition) = 1;
                    handles.TenHertzECCSSoakMask(TenHertzPosition) = 0;
                    handles.TenHertzECCSRunMask(TenHertzPosition) = 1;
                    handles.TenHertzModes(TenHertzPosition) = ControlMode;
                end
                TenHertzPosition = TenHertzPosition + 1;
            end
            OneHertzPosition = OneHertzPosition + 1;
        end
    end
end

function WriteReport(handles, PlaybackOutputDir)
% Check to see if the file exists
% if it exists then open that file and include the latest bit
% if it doesn't exist
try
    % Change the diretory path to the output file path
    CurrentDirectory = pwd;
    try
        % PlaybackFileName = [PlaybackOutputDir '\' PowerCurveName '_' TestType '_PB.txt'];
        cd(PlaybackOutputDir);
    catch %#ok<CTCH>
        cd(CurrentDirectory);
        error('MATLAB:CycleMaster:WriteReport','Non conforming file structure Cycle Master couldn''t write report');
        return;
    end

    try
        Excel = actxserver('Excel.Application');
        Excel.Visible = false;         % invisible Excel window
        Excel.ScreenUpdating = false;  % turn off screen update to run faster
        Excel.Interactive = false;     % non-interactive mode, with no keyboard/mouse
        Excel.DisplayAlerts = false;   % no prompts or alert messages
        Excel.UserControl = false;     % object freed when reference count reaches zero
    catch ME %#ok<NASGU>
        disp('ActiveX Server to Excel failed to load');
        return;
    end
    
    % ---------------------------------------------------------------------
    % Create or append to Power Map Report
    % ---------------------------------------------------------------------

    isopen = 0;
    [InstallPath, ~, ~] = fileparts(which('CycleMaster_Copy.m'));
    if ~exist([PlaybackOutputDir '/' handles.PowerCurveName '_Report.xlsx'], 'file')
        Workbook = Excel.Workbooks.Open([InstallPath '/PowerMapReportTemplate.xlsx']);
        isopen = 1;

        % Write calculated / determined data
        set(Range(Excel,'W6'),'Value',[handles.PowerCurveName '.csv']);

        set(Range(Excel,'P11'),'Value',handles.Customer);
        set(Range(Excel,'P12'),'Value',handles.Project);
        set(Range(Excel,'P13'),'Value',handles.Engine);

        set(Range(Excel,'AB11'),'Value',handles.Date);
        set(Range(Excel,'AB12'),'Value',handles.Time);
        set(Range(Excel,'AB13'),'Value',handles.Cell);

        set(Range(Excel,'AN11'),'Value',sprintf('%0.1f',handles.PSimBaro));
        set(Range(Excel,'AN12'),'Value',sprintf('%0.1f',handles.TInAir));
        set(Range(Excel,'AN13'),'Value',sprintf('%0.1f',handles.DTAir2));

        set(Range(Excel,'BB11'),'Value',sprintf('%0.1f',handles.MaxMappedSpeed));
        set(Range(Excel,'BB12'),'Value',sprintf('%0.1f',handles.MinMappedSpeed));
        set(Range(Excel,'BB13'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));

        set(Range(Excel,'P16'),'Value',handles.DeclaredMaxPower);
        set(Range(Excel,'P17'),'Value',handles.DeclaredMaxTorque);
        set(Range(Excel,'P18'),'Value',sprintf('%0.1f',handles.MeasMaximumPower));
        set(Range(Excel,'P19'),'Value',sprintf('%0.1f',handles.MeasMaximumTorque));

        set(Range(Excel,'Y16'),'Value',handles.DeclaredMaxPowerSpeed);
        set(Range(Excel,'Y17'),'Value',handles.DeclaredMaxTorqueSpeed);
        set(Range(Excel,'Y18'),'Value',sprintf('%0.1f',handles.MaxPowerSpeed));
        set(Range(Excel,'Y19'),'Value',sprintf('%0.1f',handles.MaxTorqueSpeed));

        set(Range(Excel,'AN16'),'Value',sprintf('%0.1f',handles.SpeedAtPmax));
        set(Range(Excel,'AN17'),'Value',sprintf('%0.1f',handles.MeasASpeed));
        set(Range(Excel,'AN18'),'Value',sprintf('%0.1f',handles.MeasBSpeed));
        set(Range(Excel,'AN19'),'Value',sprintf('%0.1f',handles.MeasCSpeed));
        
        % Added WH Cycles
        set(Range(Excel,'BB16'),'Value',sprintf('%0.1f',handles.WH_Nlo));
        set(Range(Excel,'BB17'),'Value',sprintf('%0.1f',handles.WH_Npref));
        set(Range(Excel,'BB18'),'Value',sprintf('%0.1f',handles.WH_N95h));
        set(Range(Excel,'BB19'),'Value',sprintf('%0.1f',handles.WH_Nhi));
        
        %{        
        set(Range(Excel,'AS16'),'Value',handles.DeclaredMaxPowerSpeed);
        set(Range(Excel,'AS17'),'Value',handles.DeclaredMeasASpeed);
        set(Range(Excel,'AS18'),'Value',handles.DeclaredMeasBSpeed);
        set(Range(Excel,'AS19'),'Value',handles.DeclaredMeasCSpeed);        
        %}

        set(Range(Excel,'V22'),'Value',sprintf('%0.1f',handles.MaxTestSpeed));
        set(Range(Excel,'V23'),'Value',sprintf('%0.1f',handles.MeasIntermediateSpeed));

        set(Range(Excel,'AP22'),'Value',sprintf('%0.2f',handles.RampRate));
        set(Range(Excel,'AP23'),'Value',sprintf('%0.1f',handles.Duration));

        set(Range(Excel,'Z26'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));
        set(Range(Excel,'Z28'),'Value',sprintf('%0.1f',handles.MeasCITTSpeed));

        set(Range(Excel,'AG26'),'Value',sprintf('%0.2f',handles.MeasIdleTorque));
        set(Range(Excel,'AG27'),'Value',sprintf('%0.2f',handles.MeasIdleTorqueDev));
        set(Range(Excel,'AG28'),'Value',sprintf('%0.2f',handles.MeasCITTTorque));
        set(Range(Excel,'AG29'),'Value',sprintf('%0.2f',handles.MeasCITTTorqueDev));

        % Now get range for data
        A = [handles.PowerCurveSpeed handles.PowerCurveTorque handles.PowerCurvePower handles.sumSquares];
        range = strcat('A1:',dec2let(size(A,2)),num2str(size(A,1)));
        Sheet = get(Excel.Sheets,'Item','Raw Data');
        Activate(Sheet);
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',A);
        Sheet = get(Excel.Sheets,'Item','Power Map Report');
        Activate(Sheet);
        invoke(Workbook, 'SaveAs', [PlaybackOutputDir '/' handles.PowerCurveName '_Report.xlsx'], 51);
    end

    if ~isopen
        Workbook = Excel.Workbooks.Open([PlaybackOutputDir '/' handles.PowerCurveName '_Report.xlsx']);
    end

    inc = 58; % first row of
    range = 'B58';
    MyRange = Range(Excel,sprintf('%s',range));
    while ~isnan(get(MyRange,'Value'))
        inc = inc+1;
        range = ['B' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
    end

    set(MyRange,'Value',handles.PlaybackFileName);

    MaxSpeed = str2double(get(handles.RatedSpeed,'String'));
    IdleSpeed = str2double(get(handles.IdleSpeed,'String'));
    CITT = str2double(get(handles.CITT,'String'));

    RMCIdleSpeed = str2double(get(handles.RMCIdleSpeed,'String'));
    RMCCITT = str2double(get(handles.RMCCITT,'String'));
    ASpeed = str2double(get(handles.RMCASpeed,'String'));
    BSpeed = str2double(get(handles.RMCBSpeed,'String'));
    CSpeed = str2double(get(handles.RMCCSpeed,'String'));
    SampleBasis = str2double(get(handles.SampleBasis,'String'));
    
    WH_Nidle = str2double(get(handles.WHIdleSpeed,'String'));
    WH_Nlo = str2double(get(handles.WHnlo,'String'));
    WH_Nhi = str2double(get(handles.WHnhi,'String'));
    WH_Npref = str2double(get(handles.WHnpref,'String'));
    WH_N95h = str2double(get(handles.WHn95h,'String'));    
    
    if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'ETC')

        % CITT, Idle Speed, Rated Speed
        range = ['Q' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','CITT');
        range = ['T' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',CITT);
        range = ['V' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Nm');

        range = ['X' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Idle Speed');
        range = ['AB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',IdleSpeed);
        range = ['AD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AF' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Max Speed');
        range = ['AJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',MaxSpeed);
        range = ['AL' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'FTP_Diesel') 
        % CITT, Idle Speed, Rated Speed
        range = ['Q' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','CITT');
        range = ['T' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',CITT);
        range = ['V' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Nm');

        range = ['X' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Idle Speed');
        range = ['AB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',IdleSpeed);
        range = ['AD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AF' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Max Speed');
        range = ['AJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',MaxSpeed);
        range = ['AL' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'FTP_Otto')
        % CITT, Idle Speed, Rated Speed
        range = ['Q' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','CITT');
        range = ['T' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',CITT);
        range = ['V' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Nm');

        range = ['X' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Idle Speed');
        range = ['AB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',IdleSpeed);
        range = ['AD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AF' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Max Speed');
        range = ['AJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',MaxSpeed);
        range = ['AL' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'LSINRTC')
        % CITT, Idle Speed, Rated Speed
        range = ['Q' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','CITT');
        range = ['T' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',CITT);
        range = ['V' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Nm');

        range = ['X' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Idle Speed');
        range = ['AB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',IdleSpeed);
        range = ['AD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AF' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Max Speed');
        range = ['AJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',MaxSpeed);
        range = ['AL' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');
        
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'NRTC')
        % CITT, Idle Speed, Rated Speed
        range = ['Q' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','CITT');
        range = ['T' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',CITT);
        range = ['V' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Nm');

        range = ['X' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Idle Speed');
        range = ['AB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',IdleSpeed);
        range = ['AD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AF' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Max Speed');
        range = ['AJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',MaxSpeed);
        range = ['AL' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'RMC') || ...
        strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'RMCNR')

        % CITT, Idle Speed, A Speed, B Speed, C Speed
        range = ['Q' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','CITT');
        range = ['T' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',RMCCITT);
        range = ['V' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Nm');

        range = ['X' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Idle Speed');
        range = ['AB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',RMCIdleSpeed);
        range = ['AD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AF' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','A Speed');
        range = ['AJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',ASpeed);
        range = ['AL' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AN' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','B Speed');
        range = ['AR' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',BSpeed);
        range = ['AT' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AV' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','C Speed');
        range = ['AZ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',CSpeed);
        range = ['BB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'ThirteenM')
        % CITT, Idle Speed, A Speed, B Speed, C Speed, Sample per 1%
        range = ['Q' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','CITT');
        range = ['T' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',RMCCITT);
        range = ['V' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Nm');

        range = ['X' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Idle Speed');
        range = ['AB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',RMCIdleSpeed);
        range = ['AD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AF' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','A Speed');
        range = ['AJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',ASpeed);
        range = ['AL' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AN' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','B Speed');
        range = ['AR' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',BSpeed);
        range = ['AT' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['AV' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','C Speed');
        range = ['AZ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',CSpeed);
        range = ['BB' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','RPM');

        range = ['BD' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','Sample per 1%');
        range = ['BH' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value',SampleBasis);
        range = ['BJ' num2str(inc)];
        MyRange = Range(Excel,sprintf('%s',range));
        set(MyRange,'Value','s');
            
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'WHSC') || ...
        strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'WHTC')
    
        set(Range(Excel,['Q' num2str(inc)]),'Value','Nidle');
        set(Range(Excel,['T' num2str(inc)]),'Value',WH_Nidle);
        set(Range(Excel,['V' num2str(inc)]),'Value','RPM');
        set(Range(Excel,['X' num2str(inc)]),'Value','Nlo');
        set(Range(Excel,['AB' num2str(inc)]),'Value',WH_Nlo);
        set(Range(Excel,['AD' num2str(inc)]),'Value','RPM');        
        set(Range(Excel,['AF' num2str(inc)]),'Value','Npref');
        set(Range(Excel,['AJ' num2str(inc)]),'Value',WH_Npref);
        set(Range(Excel,['AL' num2str(inc)]),'Value','RPM');         
        set(Range(Excel,['AN' num2str(inc)]),'Value','N95h');
        set(Range(Excel,['AR' num2str(inc)]),'Value',WH_N95h);
        set(Range(Excel,['AT' num2str(inc)]),'Value','RPM');        
        set(Range(Excel,['AV' num2str(inc)]),'Value','Nhi');
        set(Range(Excel,['AZ' num2str(inc)]),'Value',WH_Nhi);
        set(Range(Excel,['BB' num2str(inc)]),'Value','RPM');

    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'EightM')
        % CITT, Idle Speed, Intermediate Speed, Rated Speed

    else return
    end

    Workbook.Save;
    Workbook.Close;
    
    % ---------------------------------------------------------------------
    % Create Cycle Report
    % ---------------------------------------------------------------------
    Workbook = Excel.Workbooks.Open([InstallPath '/CycleReportTemplate.xlsx']);

    set(Range(Excel,'X6'),'Value',[handles.PowerCurveName '.csv']);
    set(Range(Excel,'X7'),'Value',handles.PlaybackFileName);

    set(Range(Excel,'N11'),'Value',handles.DeclaredMaxPower);
    set(Range(Excel,'N12'),'Value',handles.DeclaredMaxTorque);
    set(Range(Excel,'N13'),'Value',sprintf('%0.1f',handles.MeasMaximumPower));
    set(Range(Excel,'N14'),'Value',sprintf('%0.1f',handles.MeasMaximumTorque));

    set(Range(Excel,'W11'),'Value',handles.DeclaredMaxPowerSpeed);
    set(Range(Excel,'W12'),'Value',handles.DeclaredMaxTorqueSpeed);
    set(Range(Excel,'W13'),'Value',sprintf('%0.1f',handles.MaxPowerSpeed));
    set(Range(Excel,'W14'),'Value',sprintf('%0.1f',handles.MaxTorqueSpeed));

    if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'ETC')

        set(Range(Excel,'R17'),'Value','ETC');

        set(Range(Excel,'H18'),'Value','Motoring');
        if get(handles.UseFrictionCurve,'Value')
            set(Range(Excel,'R18'),'Value',get(handles.FrictionCurvePath,'String'));
        else
            set(Range(Excel,'R18'),'Value','Negative 40% of Power Curve');
        end

        set(Range(Excel,'H19'),'Value','Denormalization Technique');
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R19'),'Value','Part 1065');
        else
            set(Range(Excel,'R19'),'Value','Part 86');
        end

        set(Range(Excel,'H20'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R20'),'Value','10 Hz');
        else
            set(Range(Excel,'R20'),'Value','1 Hz');
        end

        set(Range(Excel,'H21'),'Value','Speed Control Mode');
        set(Range(Excel,'R21'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H22'),'Value','Idle Control Mode');
        set(Range(Excel,'R22'),'Value',get(handles.IdleControlMode,'String'));

        set(Range(Excel,'H23'),'Value','Motoring Control Mode');
        set(Range(Excel,'R23'),'Value',get(handles.MotorControlMode,'String'));

        % Second Table

        set(Range(Excel,'H27'),'Value','CITT');
        set(Range(Excel,'N27'),'Value',get(handles.CITT,'String'));
        set(Range(Excel,'R27'),'Value','-');
        set(Range(Excel,'V27'),'Value','N.m');

        set(Range(Excel,'H28'),'Value','Idle Speed');
        set(Range(Excel,'N28'),'Value',get(handles.IdleSpeed,'String'));
        set(Range(Excel,'R28'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));
        set(Range(Excel,'V28'),'Value','RPM');

        set(Range(Excel,'H29'),'Value','Max Test Speed');
        set(Range(Excel,'N29'),'Value',get(handles.RatedSpeed,'String'));
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.SpeedAtPmax));
        else
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.MaxTestSpeed));
        end
        set(Range(Excel,'V29'),'Value','RPM');
        
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'FTP_Diesel')

        set(Range(Excel,'R17'),'Value','FTP_Diesel');

        set(Range(Excel,'H18'),'Value','Motoring');
        if get(handles.UseFrictionCurve,'Value')
            set(Range(Excel,'R18'),'Value',get(handles.FrictionCurvePath,'String'));
        else
            set(Range(Excel,'R18'),'Value','Negative 40% of Power Curve');
        end

        set(Range(Excel,'H19'),'Value','Denormalization Technique');
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R19'),'Value','Part 1065');
        else
            set(Range(Excel,'R19'),'Value','Part 86');
        end

        set(Range(Excel,'H20'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R20'),'Value','10 Hz');
        else
            set(Range(Excel,'R20'),'Value','1 Hz');
        end

        set(Range(Excel,'H21'),'Value','Speed Control Mode');
        set(Range(Excel,'R21'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H22'),'Value','Idle Control Mode');
        set(Range(Excel,'R22'),'Value',get(handles.IdleControlMode,'String'));

        set(Range(Excel,'H23'),'Value','Motoring Control Mode');
        set(Range(Excel,'R23'),'Value',get(handles.MotorControlMode,'String'));

        % Second Table

        set(Range(Excel,'H27'),'Value','CITT');
        set(Range(Excel,'N27'),'Value',get(handles.CITT,'String'));
        set(Range(Excel,'R27'),'Value','-');
        set(Range(Excel,'V27'),'Value','N.m');

        set(Range(Excel,'H28'),'Value','Idle Speed');
        set(Range(Excel,'N28'),'Value',get(handles.IdleSpeed,'String'));
        set(Range(Excel,'R28'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));
        set(Range(Excel,'V28'),'Value','RPM');

        set(Range(Excel,'H29'),'Value','Max Test Speed');
        set(Range(Excel,'N29'),'Value',get(handles.RatedSpeed,'String'));
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.SpeedAtPmax));
        else
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.MaxTestSpeed));
        end
        set(Range(Excel,'V29'),'Value','RPM');

    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'FTP_Otto')

        set(Range(Excel,'R17'),'Value','FTP_Otto');

        set(Range(Excel,'H18'),'Value','Motoring');
        if get(handles.UseFrictionCurve,'Value')
            set(Range(Excel,'R18'),'Value',get(handles.FrictionCurvePath,'String'));
        else
            set(Range(Excel,'R18'),'Value','Negative 40% of Power Curve');
        end

        set(Range(Excel,'H19'),'Value','Denormalization Technique');
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R19'),'Value','Part 1065');
        else
            set(Range(Excel,'R19'),'Value','Part 86');
        end

        set(Range(Excel,'H20'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R20'),'Value','10 Hz');
        else
            set(Range(Excel,'R20'),'Value','1 Hz');
        end

        set(Range(Excel,'H21'),'Value','Speed Control Mode');
        set(Range(Excel,'R21'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H22'),'Value','Idle Control Mode');
        set(Range(Excel,'R22'),'Value',get(handles.IdleControlMode,'String'));

        set(Range(Excel,'H23'),'Value','Motoring Control Mode');
        set(Range(Excel,'R23'),'Value',get(handles.MotorControlMode,'String'));

        % Second Table

        set(Range(Excel,'H27'),'Value','CITT');
        set(Range(Excel,'N27'),'Value',get(handles.CITT,'String'));
        set(Range(Excel,'R27'),'Value','-');
        set(Range(Excel,'V27'),'Value','N.m');

        set(Range(Excel,'H28'),'Value','Idle Speed');
        set(Range(Excel,'N28'),'Value',get(handles.IdleSpeed,'String'));
        set(Range(Excel,'R28'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));
        set(Range(Excel,'V28'),'Value','RPM');

        set(Range(Excel,'H29'),'Value','Max Test Speed');
        set(Range(Excel,'N29'),'Value',get(handles.RatedSpeed,'String'));
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.SpeedAtPmax));
        else
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.MaxTestSpeed));
        end
        set(Range(Excel,'V29'),'Value','RPM');
        
        elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'NRTC')

        set(Range(Excel,'R17'),'Value','NRTC');

        set(Range(Excel,'H18'),'Value','Motoring');
        if get(handles.UseFrictionCurve,'Value')
            set(Range(Excel,'R18'),'Value',get(handles.FrictionCurvePath,'String'));
        else
            set(Range(Excel,'R18'),'Value','Negative 40% of Power Curve');
        end

        set(Range(Excel,'H19'),'Value','Denormalization Technique');
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R19'),'Value','Part 1065');
        else
            set(Range(Excel,'R19'),'Value','Part 86');
        end

        set(Range(Excel,'H20'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R20'),'Value','10 Hz');
        else
            set(Range(Excel,'R20'),'Value','1 Hz');
        end

        set(Range(Excel,'H21'),'Value','Speed Control Mode');
        set(Range(Excel,'R21'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H22'),'Value','Idle Control Mode');
        set(Range(Excel,'R22'),'Value',get(handles.IdleControlMode,'String'));

        set(Range(Excel,'H23'),'Value','Motoring Control Mode');
        set(Range(Excel,'R23'),'Value',get(handles.MotorControlMode,'String'));

        % Second Table

        set(Range(Excel,'H27'),'Value','CITT');
        set(Range(Excel,'N27'),'Value',get(handles.CITT,'String'));
        set(Range(Excel,'R27'),'Value','-');
        set(Range(Excel,'V27'),'Value','N.m');

        set(Range(Excel,'H28'),'Value','Idle Speed');
        set(Range(Excel,'N28'),'Value',get(handles.IdleSpeed,'String'));
        set(Range(Excel,'R28'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));
        set(Range(Excel,'V28'),'Value','RPM');

        set(Range(Excel,'H29'),'Value','Max Test Speed');
        set(Range(Excel,'N29'),'Value',get(handles.RatedSpeed,'String'));
        if get(handles.UsePart1065Method,'Value')
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.SpeedAtPmax));
        else
            set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.MaxTestSpeed));
        end
        set(Range(Excel,'V29'),'Value','RPM');
        
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'RMC')

        set(Range(Excel,'R17'),'Value','RMC');

        set(Range(Excel,'H18'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R18'),'Value','10 Hz');
        else
            set(Range(Excel,'R18'),'Value','1 Hz');
        end

        set(Range(Excel,'H19'),'Value','Speed Control Mode');
        set(Range(Excel,'R19'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H20'),'Value','Idle Control Mode');
        set(Range(Excel,'R20'),'Value',get(handles.IdleControlMode,'String'));

        % Second Table

        set(Range(Excel,'H27'),'Value','CITT');
        set(Range(Excel,'N27'),'Value',get(handles.RMCCITT,'String'));
        set(Range(Excel,'R27'),'Value','-');
        set(Range(Excel,'V27'),'Value','N.m');

        set(Range(Excel,'H28'),'Value','Idle Speed');
        set(Range(Excel,'N28'),'Value',get(handles.RMCIdleSpeed,'String'));
        set(Range(Excel,'R28'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));
        set(Range(Excel,'V28'),'Value','RPM');

        set(Range(Excel,'H29'),'Value','A Speed');
        set(Range(Excel,'N29'),'Value',get(handles.RMCASpeed,'String'));
        set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.MeasASpeed));
        set(Range(Excel,'V29'),'Value','RPM');

        set(Range(Excel,'H30'),'Value','B Speed');
        set(Range(Excel,'N30'),'Value',get(handles.RMCBSpeed,'String'));
        set(Range(Excel,'R30'),'Value',sprintf('%0.1f',handles.MeasBSpeed));
        set(Range(Excel,'V30'),'Value','RPM');

        set(Range(Excel,'H31'),'Value','C Speed');
        set(Range(Excel,'N31'),'Value',get(handles.RMCCSpeed,'String'));
        set(Range(Excel,'R31'),'Value',sprintf('%0.1f',handles.MeasCSpeed));
        set(Range(Excel,'V31'),'Value','RPM');
        
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'RMCNR')

        set(Range(Excel,'R17'),'Value','RMC');

        set(Range(Excel,'H18'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R18'),'Value','10 Hz');
        else
            set(Range(Excel,'R18'),'Value','1 Hz');
        end

        set(Range(Excel,'H19'),'Value','Speed Control Mode');
        set(Range(Excel,'R19'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H20'),'Value','Idle Control Mode');
        set(Range(Excel,'R20'),'Value',get(handles.IdleControlMode,'String'));
        
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'ThirteenM')

        set(Range(Excel,'R17'),'Value','RMC');

        set(Range(Excel,'H18'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R18'),'Value','10 Hz');
        else
            set(Range(Excel,'R18'),'Value','1 Hz');
        end

        set(Range(Excel,'H19'),'Value','Speed Control Mode');
        set(Range(Excel,'R19'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H20'),'Value','Idle Control Mode');
        set(Range(Excel,'R20'),'Value',get(handles.IdleControlMode,'String'));

        set(Range(Excel,'H27'),'Value','CITT');
        set(Range(Excel,'N27'),'Value',get(handles.RMCCITT,'String'));
        set(Range(Excel,'R27'),'Value','-');
        set(Range(Excel,'V27'),'Value','N.m');

        set(Range(Excel,'H28'),'Value','Idle Speed');
        set(Range(Excel,'N28'),'Value',get(handles.RMCIdleSpeed,'String'));
        set(Range(Excel,'R28'),'Value',sprintf('%0.1f',handles.MeasIdleSpeed));
        set(Range(Excel,'V28'),'Value','RPM');

        set(Range(Excel,'H29'),'Value','A Speed');
        set(Range(Excel,'N29'),'Value',get(handles.RMCASpeed,'String'));
        set(Range(Excel,'R29'),'Value',sprintf('%0.1f',handles.MeasASpeed));
        set(Range(Excel,'V29'),'Value','RPM');

        set(Range(Excel,'H30'),'Value','B Speed');
        set(Range(Excel,'N30'),'Value',get(handles.RMCBSpeed,'String'));
        set(Range(Excel,'R30'),'Value',sprintf('%0.1f',handles.MeasBSpeed));
        set(Range(Excel,'V30'),'Value','RPM');

        set(Range(Excel,'H31'),'Value','C Speed');
        set(Range(Excel,'N31'),'Value',get(handles.RMCCSpeed,'String'));
        set(Range(Excel,'R31'),'Value',sprintf('%0.1f',handles.MeasCSpeed));
        set(Range(Excel,'V31'),'Value','RPM');

        set(Range(Excel,'H27'),'Value','Sample per 1%');
        set(Range(Excel,'N27'),'Value',get(handles.SampleBasis,'String'));
        set(Range(Excel,'R27'),'Value','-');
        set(Range(Excel,'V27'),'Value','s');
        
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'WHSC') || ...
        strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'WHTC')

        set(Range(Excel,'R17'),'Value','WHSC');

        set(Range(Excel,'H18'),'Value','Motoring');
        if get(handles.UseFrictionCurve,'Value')
            set(Range(Excel,'R18'),'Value',get(handles.FrictionCurvePath,'String'));
        else
            set(Range(Excel,'R18'),'Value','Negative 40% of Power Curve');
        end

        set(Range(Excel,'H19'),'Value','Denormalization Technique');
        set(Range(Excel,'R19'),'Value','Stage V');

        set(Range(Excel,'H20'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R20'),'Value','10 Hz');
        else
            set(Range(Excel,'R20'),'Value','1 Hz');
        end

        set(Range(Excel,'H21'),'Value','Speed Control Mode');
        set(Range(Excel,'R21'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H22'),'Value','Idle Control Mode');
        set(Range(Excel,'R22'),'Value',get(handles.IdleControlMode,'String'));

        set(Range(Excel,'H23'),'Value','Motoring Control Mode');
        set(Range(Excel,'R23'),'Value',get(handles.MotorControlMode,'String'));

        % Second Table

        set(Range(Excel,'H27'),'Value','Nidle');
        set(Range(Excel,'N27'),'Value',get(handles.WHIdleSpeed,'String'));
        set(Range(Excel,'R27'),'Value',sprintf('%0.1f',handles.WH_Nidle));
        set(Range(Excel,'V27'),'Value','RPM');

        set(Range(Excel,'H27'),'Value','Nlo');
        set(Range(Excel,'N27'),'Value',get(handles.WHnlo,'String'));
        set(Range(Excel,'R27'),'Value',sprintf('%0.1f',handles.WH_Nlo));
        set(Range(Excel,'V27'),'Value','RPM');

        set(Range(Excel,'H27'),'Value','Npref');
        set(Range(Excel,'N27'),'Value',get(handles.WHnpref,'String'));
        set(Range(Excel,'R27'),'Value',sprintf('%0.1f',handles.WH_Npref));
        set(Range(Excel,'V27'),'Value','RPM');           

        set(Range(Excel,'H27'),'Value','N95h');
        set(Range(Excel,'N27'),'Value',get(handles.WHn95h,'String'));
        set(Range(Excel,'R27'),'Value',sprintf('%0.1f',handles.WH_N95h));
        set(Range(Excel,'V27'),'Value','RPM');            

        set(Range(Excel,'H27'),'Value','Nhi');
        set(Range(Excel,'N27'),'Value',get(handles.WHnhi,'String'));
        set(Range(Excel,'R27'),'Value',sprintf('%0.1f',handles.WH_Nhi));
        set(Range(Excel,'V27'),'Value','RPM');   
        
    elseif strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')}, 'EightM')
            
        set(Range(Excel,'R17'),'Value','RMC');

        set(Range(Excel,'H18'),'Value','Playback Frequency');
        if get(handles.TenHzPlayback,'Value')
            set(Range(Excel,'R18'),'Value','10 Hz');
        else
            set(Range(Excel,'R18'),'Value','1 Hz');
        end

        set(Range(Excel,'H19'),'Value','Speed Control Mode');
        set(Range(Excel,'R19'),'Value',get(handles.SpeedControlMode,'String'));

        set(Range(Excel,'H20'),'Value','Idle Control Mode');
        set(Range(Excel,'R20'),'Value',get(handles.IdleControlMode,'String'));

    end

    A = [(0:length(handles.OneHertzDenormSpeed)-1)' handles.OneHertzDenormSpeed handles.OneHertzDenormLoad];
    range = strcat('A1:',dec2let(size(A,2)),num2str(size(A,1)));
    Sheet = get(Excel.Sheets,'Item','Raw Data');
    Activate(Sheet);
    MyRange = Range(Excel,sprintf('%s',range));
    set(MyRange,'Value',A);
    Sheet = get(Excel.Sheets,'Item','Cycle Report');
    Activate(Sheet);
    invoke(Workbook, 'SaveAs', [PlaybackOutputDir '/' handles.PlaybackFileName '_Report.xlsx'], 51);
    Workbook.Close;
    Excel.Quit;

    cd(CurrentDirectory); %return to original file position
catch ME %#ok<CTCH>
    % If report writing fails then return to the originating directory.
    warning('MATLAB:CycleMaster:WriteReport','Report writing failed'); %sorry didn't feel like adding in the exception so you could discern where exactly this stupid thing - when this fails cut out this line and try, try again
    Excel.Quit;
    set(handles.lblBusy,'Visible','off');
    cd(CurrentDirectory);
end

function s = dec2let(d)

list = 'A':'Z';
ext ='';
if d > 702
    ext = list(floor((d-26)/676)-(floor((d-26)/676)==(d-26)/676));
    d = d-(floor((d-26)/676)-(floor((d-26)/676)==(d-26)/676))*676;
end
if d > 26
    s = strcat(ext,list(floor(d/26)-(floor(d/26)==d/26)),list(mod(d,26)+26*(floor(d/26)==d/26)));
else
    s = list(mod(d,26)+26*(floor(d/26)==d/26));
end

function SampleBasis_Callback(hObject, eventdata, handles)
% hObject    handle to SampleBasis (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of SampleBasis as text
%        str2double(get(hObject,'String')) returns contents of SampleBasis as a double

if strcmp(handles.Cycle{get(handles.CycleSelecter,'Value')},'ThirteenM')
    if str2double(get(hObject,'String')) < 4
        set(hObject,'String','4')
    end

    if str2double(get(hObject,'String')) > 10
        set(hObject,'String','10')
    end
end
set(handles.CreatePlayback,'Enable','off');

% --- Executes during object creation, after setting all properties.
function SampleBasis_CreateFcn(hObject, eventdata, handles)
% hObject    handle to SampleBasis (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

function OutputDirectory_Callback(hObject, eventdata, handles)
% hObject    handle to OutputDirectory (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of OutputDirectory as text
%        str2double(get(hObject,'String')) returns contents of OutputDirectory as a double
verifyOutputDir(handles);

% Update handles structure
guidata(hObject, handles);

% --- Executes during object creation, after setting all properties.
function OutputDirectory_CreateFcn(hObject, eventdata, handles)
% hObject    handle to OutputDirectory (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

function status = verifyOutputDir(handles)
% This function verifies that the output directory exists and can be
% written to. It also cleans up the directory if extra backslashes, etc.
% are typed in the OutputDirectory text box.

OutputDir = get(handles.OutputDirectory, 'String');
[status, message] = fileattrib(OutputDir);

if status == 1 && message.UserWrite ~= 1
    set(handles.OutputDirectory, 'String', '');
    msgbox(['You are not allowed to write to ' OutputDir '. Please choose another location to place the playback file.'],'Cycle Master: Write Privileges');
elseif status == 0
    msgbox([OutputDir ' is not a valid directory. Please choose another location to place the playback file.'],'Cycle Master: Invalid Directory');
else
    set(handles.OutputDirectory, 'String', message.Name);
end

% -------------------------------------------------------------------------
%   Object Creation Code
% -------------------------------------------------------------------------

% --- Executes during object creation, after setting all properties.
function IdleSpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to IdleSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function MeasMaxTestSpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to MeasMaxTestSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function CITT_CreateFcn(hObject, eventdata, handles)
% hObject    handle to CITT (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function CycleSelecter_CreateFcn(hObject, eventdata, handles)
% hObject    handle to CycleSelecter (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: popupmenu controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% Define the cycles as a cell array and store in the handles structure.
% This array is used throughout the code to identify the selected cycle.
% The current mapping between handles.CycleSelecter values and the cycle
% they refer to is shown below.

% Value     Cycle
% -----     -----
%   1       no cycle selected (' ')
%   2       ETC
%   3       FTP-Diesel
%   4       FTP-Otto
%   5       LSI-NRTC
%   6       NRTC
%   7       RMC
%   8       RMCNR
%   9       13M
%   10      WHSC
%   11      WHTC

handles.Cycle = {'ETC', 'FTP_Diesel', 'FTP_Otto', 'LSINRTC', 'NRTC', 'RMC', 'RMCNR', 'ThirteenM', 'WHSC', 'WHTC'};

% Populate the CycleSelecter list box using the same cycles as those listed
% above. Note that this will overwrite the handles.CycleSelecter 'String'
% values originally entered when the GUI was created.
listboxItems = strrep(handles.Cycle,'_','-');
listboxItems = strrep(listboxItems,'ThirteenM','13M');
set(hObject, 'string', listboxItems);
guidata(hObject,handles);

% --- Executes during object creation, after setting all properties.
function IdleControlMode_CreateFcn(hObject, eventdata, handles)
% hObject    handle to IdleControlMode (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function SpeedControlMode_CreateFcn(hObject, eventdata, handles)
% hObject    handle to SpeedControlMode (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function MotorControlMode_CreateFcn(hObject, eventdata, handles) %#ok<*DEFNU,*INUSD>
% hObject    handle to MotorControlMode (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function RatedSpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RatedSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function SpeedRamp_CreateFcn(hObject, eventdata, handles)
% hObject    handle to SpeedRamp (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function LoadRamp_CreateFcn(hObject, eventdata, handles)
% hObject    handle to LoadRamp (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function RMCIdleSpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RMCIdleSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function RMCCITT_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RMCCITT (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function RMCASpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RMCASpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function RMCBSpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RMCBSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function RMCCSpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to RMCCSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function WHIdleSpeed_CreateFcn(hObject, eventdata, handles)
% hObject    handle to WHIdleSpeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function WHnlo_CreateFcn(hObject, eventdata, handles)
% hObject    handle to WHnlo (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function WHnpref_CreateFcn(hObject, eventdata, handles)
% hObject    handle to WHnpref (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function WHn95h_CreateFcn(hObject, eventdata, handles)
% hObject    handle to WHn95h (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end

% --- Executes during object creation, after setting all properties.
function WHnhi_CreateFcn(hObject, eventdata, handles)
% hObject    handle to WHnhi (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end